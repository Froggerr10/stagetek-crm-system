# Story 4.1: Importação CSV em Massa (Produtos & Clientes)

**Epic**: EPIC-004 | **Status**: Draft | **Prioridade**: P1 (Backlog pós-MVP) | **Estimativa**: 3 dias

## Story
Como usuário, quero importar múltiplos **Produtos** e **Clientes** de uma vez usando planilhas (CSV/Excel), para não ter que cadastrar um a um manualmente.

## Contexto

**Problema atual:**
- Cadastrar 50+ clientes ou 15+ produtos um a um é **lento** e **propenso a erros**
- Migração de dados existentes (planilhas atuais) para o CRM é **inviável** manualmente
- Competidores (HubSpot, Pipedrive, RD Station) oferecem essa funcionalidade

**Valor de negócio:**
- **Produtividade:** Economia de 95% do tempo (50 clientes em 2min vs 2h+)
- **Adoção:** Facilita migração de dados existentes
- **UX:** Standard da indústria, esperado pelos usuários

## AC (Acceptance Criteria)

### AC1: Download de Template CSV
- [ ] Botão "Baixar Modelo CSV" em `/clientes` e `/produtos`
- [ ] Template CSV com **cabeçalhos corretos** (ver schemas abaixo)
- [ ] Primeira linha: nomes dos campos
- [ ] Segunda linha: exemplo preenchido
- [ ] Formato UTF-8 com BOM (compatível Excel Brasil)

### AC2: Upload e Preview
- [ ] Área de drag-and-drop (React Dropzone ou similar)
- [ ] Aceita `.csv`, `.xlsx`, `.xls`
- [ ] Converte Excel → CSV automaticamente (SheetJS)
- [ ] Preview tabular dos primeiros 10 registros
- [ ] Exibe total de linhas encontradas

### AC3: Validação Pré-Importação
- [ ] **Campos obrigatórios:** Destaca linhas com campos vazios
- [ ] **Duplicatas:** Detecta CNPJ ou SKU duplicado (no arquivo E no banco)
- [ ] **Formato:** Valida email, telefone, preços numéricos
- [ ] **Categorias:** Valida valores de enums (category, status)
- [ ] Exibe **lista de erros** com linha e campo
- [ ] Botão "Importar" só ativo se 0 erros

### AC4: Importação em Batch
- [ ] Insere em lotes de 50 registros (performance)
- [ ] Progress bar com % concluído
- [ ] Sucesso: Exibe total de registros inseridos
- [ ] Erro parcial: Exibe quais linhas falharam + motivo
- [ ] Rollback automático se falhar >20% dos registros

### AC5: Feedback Pós-Importação
- [ ] Toast de sucesso: "48 clientes importados com sucesso!"
- [ ] Relatório detalhado (modal ou download):
  - Total processado
  - Total inserido
  - Linhas com erro (número + motivo)
- [ ] Redireciona para lista de clientes/produtos após fechar

## Schemas de Template CSV

### Template: `clientes_template.csv`

```csv
name,cnpj,email,phone,website,address_street,address_city,address_state,address_zip,segment,status,notes
"Mega Produções",12.345.678/0001-90,contato@megaprod.com,(11) 98765-4321,https://megaprod.com,"Av. Paulista, 1000",São Paulo,SP,01310-100,Eventos,active,"Cliente desde 2020"
```

**Campos:**
- **Obrigatórios:** name, cnpj, email
- **Opcionais:** phone, website, address_*, segment, notes
- **Enum status:** active | inactive | pending (default: active)
- **Enum segment:** Eventos | Shows | Corporativo | Governo | Igrejas

### Template: `produtos_template.csv`

```csv
name,sku,category,price_brl,price_usd,price_eur,description,is_active
"Caixa JBL PRX815",PRX815-JBL,som,8500.00,1700.00,1600.00,"Caixa ativa 1500W RMS",true
"Truss Q30 3m",Q30-3M,estrutura,450.00,90.00,85.00,"Treliça quadrada 30x30cm",true
```

**Campos:**
- **Obrigatórios:** name, category, price_brl
- **Opcionais:** sku, price_usd, price_eur, description, technical_specs (JSON), image_url
- **Enum category (quotation):** som | luz | estrutura | talha | outro
- **Enum category (full):** fabricacao | revenda_som | revenda_luz | locacao
- **Formato preço:** Número decimal (ponto como separador: 1500.00)

## Tasks

### Backend (1 dia)
- [ ] Criar endpoint POST `/api/import/clients` (Edge Function)
- [ ] Criar endpoint POST `/api/import/products` (Edge Function)
- [ ] Implementar validação de schemas (Zod ou Joi)
- [ ] Implementar detecção de duplicatas (CNPJ, SKU)
- [ ] Implementar inserção em batch (50 registros/vez)
- [ ] Adicionar logs de importação em tabela `import_logs`

### Frontend (1.5 dias)
- [ ] Criar componente `CSVImporter` organism (≤50 linhas)
- [ ] Integrar React Dropzone para drag-and-drop
- [ ] Implementar preview tabular (React Table ou similar)
- [ ] Criar validação client-side (mesmas regras do backend)
- [ ] Implementar progress bar (React Query + polling ou websocket)
- [ ] Criar modal de relatório pós-importação
- [ ] Adicionar botão "Baixar Modelo CSV" em `/clientes` e `/produtos`

### Utils/Libs (0.5 dia)
- [ ] Instalar dependências: `react-dropzone`, `papaparse` (CSV parser), `xlsx` (Excel)
- [ ] Criar utility `parseCSV()` (converte CSV/Excel → array de objetos)
- [ ] Criar utility `validateImportData()` (validação client-side)
- [ ] Criar utility `downloadTemplateCSV()` (gera CSV template)

## Dev Notes

### Bibliotecas Recomendadas
```bash
npm install react-dropzone papaparse xlsx zod
```

- **react-dropzone**: Drag-and-drop area (15KB gzipped)
- **papaparse**: CSV parser rápido e confiável
- **xlsx**: Leitura de Excel (SheetJS)
- **zod**: Validação de schema (já usado no projeto?)

### Considerações Técnicas

1. **Limite de arquivo:**
   - Máximo 1000 linhas por importação (Excel pode ter 50k+)
   - Máximo 2MB de arquivo
   - Validar no frontend antes de upload

2. **Performance:**
   - Processar CSV no cliente (parsing)
   - Enviar JSON para backend (não CSV raw)
   - Backend insere em batches de 50 (evita timeout)

3. **Segurança:**
   - RLS policies aplicam (somente authenticated)
   - Validar TODOS os campos no backend (nunca confiar no frontend)
   - Sanitizar strings (XSS prevention)

4. **UX:**
   - Preview imediato após upload
   - Feedback em tempo real (não esperar 30s)
   - Permitir editar campos com erro antes de reimportar

### Exemplo de Flow

```
1. Usuário baixa template CSV
2. Preenche no Excel/Google Sheets
3. Exporta como CSV (UTF-8)
4. Arrasta arquivo para área de drop
5. Frontend parseia CSV → JSON
6. Frontend valida campos
7. Exibe preview + erros (se houver)
8. Usuário corrige erros OU reimporta arquivo
9. Clica "Importar"
10. Frontend envia JSON para Edge Function
11. Backend valida + detecta duplicatas
12. Backend insere em batches
13. Frontend exibe progress bar
14. Sucesso: Toast + relatório
15. Redireciona para lista
```

## Testing

### Casos de Teste (Manual)
- [ ] Importar CSV válido (10 registros) → Sucesso
- [ ] Importar CSV com campos faltando → Erro destacado
- [ ] Importar CSV com CNPJ duplicado → Aviso de duplicata
- [ ] Importar Excel (.xlsx) → Converte e processa
- [ ] Importar arquivo >1000 linhas → Erro: "máximo 1000"
- [ ] Importar CSV com encoding errado → Detecta e converte
- [ ] Cancelar importação no meio → Rollback

### Edge Cases
- [ ] CSV vazio (só headers)
- [ ] CSV com colunas a mais (ignorar)
- [ ] CSV com colunas a menos (erro)
- [ ] CSV com caracteres especiais (ç, á, ã)
- [ ] Excel com múltiplas abas (usar só primeira)

## File List
(A preencher durante implementação)

## Change Log
(A preencher durante implementação)

## Completion Notes
(A preencher ao finalizar)

---

## Anexo: Database Schema Reference

### Clients Table
```sql
CREATE TABLE clients (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  name VARCHAR(255) NOT NULL,
  cnpj VARCHAR(18) UNIQUE,
  email VARCHAR(255),
  phone VARCHAR(20),
  website VARCHAR(255),
  address JSONB DEFAULT '{}', -- { street, city, state, zip }
  status VARCHAR(20) DEFAULT 'active' CHECK (status IN ('active', 'inactive', 'pending')),
  segment TEXT,
  notes TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

### Products Table (Quotation System)
```sql
CREATE TABLE products (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  name VARCHAR(255) NOT NULL,
  sku VARCHAR(50) UNIQUE,
  category VARCHAR(50) NOT NULL CHECK (category IN ('som', 'luz', 'estrutura', 'talha', 'outro')),
  price_brl DECIMAL(10, 2) NOT NULL,
  price_usd DECIMAL(10, 2),
  price_eur DECIMAL(10, 2),
  description TEXT,
  technical_specs JSONB DEFAULT '{}',
  image_url TEXT,
  is_active BOOLEAN DEFAULT TRUE,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

---

**Criado por:** Claude Code (BMad Developer)
**Data:** 19 Nov 2025
**Próxima ação:** Mover para backlog Sprint 2 após MVP estabilizar
