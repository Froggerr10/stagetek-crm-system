# Story 6.1: Sincroniza√ß√£o Manual Omie (MVP)

**Epic**: EPIC-006 | **Status**: Draft | **Prioridade**: P1 | **Estimativa**: 1 semana (5 dias)

---

## üìù Story

Como **vendedor**, quero sincronizar clientes e produtos do Omie ERP com o STAGETEK CRM atrav√©s de um bot√£o, para **eliminar dupla digita√ß√£o** e manter dados sempre atualizados.

---

## ‚úÖ Acceptance Criteria (AC)

### AC1: Bot√£o de Sincroniza√ß√£o
- [ ] P√°gina `/clientes` tem bot√£o "‚ü≥ Sincronizar com Omie"
- [ ] Bot√£o mostra loading spinner durante sync
- [ ] Toast exibe "X clientes sincronizados com sucesso" ao finalizar
- [ ] Toast exibe erro caso falhe (com bot√£o "Tentar Novamente")

### AC2: Sincroniza√ß√£o de Clientes
- [ ] Edge Function `omie-sync-clients` busca clientes do Omie
- [ ] Apenas clientes novos/modificados desde √∫ltimo sync s√£o processados
- [ ] Clientes j√° existentes (match por CNPJ) s√£o atualizados (n√£o duplicados)
- [ ] Novos clientes s√£o inseridos em `clients` table
- [ ] Mapeamento de IDs salvo em `omie_sync_map` table

### AC3: Sincroniza√ß√£o de Produtos
- [ ] Edge Function `omie-sync-products` busca produtos do Omie
- [ ] Apenas produtos ativos (`inativo = false` no Omie) s√£o sincronizados
- [ ] Produtos existentes (match por SKU) s√£o atualizados
- [ ] Novos produtos s√£o inseridos em `products` table
- [ ] Pre√ßos em BRL s√£o sincronizados (`price_brl`)

### AC4: Tabelas de Controle
- [ ] Tabela `omie_sync_map` registra mapeamento de IDs
- [ ] Tabela `omie_sync_log` registra cada sync (status, total, erros)
- [ ] RLS policies permitem apenas usu√°rios autenticados INSERT

### AC5: Valida√ß√£o e Seguran√ßa
- [ ] Credenciais Omie (App Key + Secret) armazenadas em secrets Supabase
- [ ] Valida√ß√£o Zod em todas respostas da API Omie
- [ ] Timeout de 30s por requisi√ß√£o (evita travamento)
- [ ] Rollback em caso de erro cr√≠tico (transa√ß√£o SQL)

---

## üéØ Tasks

### Task 1: Database Schema (1h)
- [ ] Criar migration `20251212_create_omie_sync_tables.sql`
- [ ] Criar tabela `omie_sync_map` com indexes
- [ ] Criar tabela `omie_sync_log` com indexes
- [ ] Adicionar campo `omie_client_id` em `clients` table (nullable)
- [ ] Adicionar campo `omie_product_id` em `products` table (nullable)
- [ ] Rodar migration em Supabase local (`npx supabase db reset`)

### Task 2: Edge Function - Clientes (4h)
- [ ] Criar Edge Function `supabase/functions/omie-sync-clients/index.ts`
- [ ] Implementar autentica√ß√£o Omie (App Key + Secret)
- [ ] Implementar m√©todo `ListarClientes` (Omie API)
- [ ] Implementar l√≥gica de sync incremental (apenas novos desde `last_sync`)
- [ ] Implementar upsert de clientes (INSERT ou UPDATE por CNPJ)
- [ ] Salvar mapeamento em `omie_sync_map`
- [ ] Registrar log em `omie_sync_log`
- [ ] Adicionar valida√ß√£o Zod na resposta
- [ ] Testar manualmente via Postman

### Task 3: Edge Function - Produtos (3h)
- [ ] Criar Edge Function `supabase/functions/omie-sync-products/index.ts`
- [ ] Implementar m√©todo `ListarProdutos` (Omie API)
- [ ] Filtrar apenas produtos ativos
- [ ] Implementar upsert de produtos (INSERT ou UPDATE por SKU)
- [ ] Salvar mapeamento em `omie_sync_map`
- [ ] Registrar log em `omie_sync_log`
- [ ] Testar manualmente

### Task 4: Types TypeScript (1h)
- [ ] Criar `src/types/omie.ts`
- [ ] Definir interface `OmieClient` (campos da API)
- [ ] Definir interface `OmieProduct`
- [ ] Definir interface `OmieSyncMap`
- [ ] Definir interface `OmieSyncLog`
- [ ] Exportar schemas Zod para valida√ß√£o

### Task 5: Hook React (2h)
- [ ] Criar `src/hooks/useOmieSync.ts`
- [ ] Implementar m√©todo `syncClients()` (chama Edge Function)
- [ ] Implementar m√©todo `syncProducts()`
- [ ] Implementar m√©todo `getLastSync()` (l√™ `omie_sync_log`)
- [ ] Loading state management
- [ ] Error handling com retry

### Task 6: UI Component (2h)
- [ ] Criar `src/components/atoms/OmieSyncButton.tsx` (atom ‚â§30 linhas)
- [ ] Bot√£o com √≠cone ‚ü≥ + texto "Sincronizar com Omie"
- [ ] Loading spinner (Lucide `Loader2` com anima√ß√£o spin)
- [ ] Disabled state durante sync
- [ ] Integrar hook `useOmieSync`

### Task 7: Integra√ß√£o na P√°gina Clientes (1h)
- [ ] Adicionar `OmieSyncButton` em `src/pages/Clientes.tsx`
- [ ] Posicionar no topo da p√°gina (alinhado √† direita)
- [ ] Toast de sucesso: "42 clientes sincronizados"
- [ ] Toast de erro: "Erro ao sincronizar. Tentar novamente?"
- [ ] Recarregar lista de clientes ap√≥s sync bem-sucedido

### Task 8: Testes (4h)
- [ ] Obter credenciais de sandbox Omie
- [ ] Testar sync de 10 clientes reais
- [ ] Verificar duplicatas (n√£o devem existir)
- [ ] Testar sync incremental (apenas novos)
- [ ] Testar com Omie API offline (simular erro)
- [ ] Verificar logs em `omie_sync_log`
- [ ] Validar RLS policies

### Task 9: Documenta√ß√£o (1h)
- [ ] Atualizar `docs/architecture/omie-integration-feasibility.md`
- [ ] Documentar como obter credenciais Omie
- [ ] Documentar processo de sync manual
- [ ] Adicionar screenshots em `docs/screenshots/omie-sync.png`

---

## üß™ Testing

### Testes Unit√°rios (Edge Functions)
```typescript
// Testar parsing de resposta Omie
test('deve parsear cliente Omie corretamente', () => {
  const omieResponse = {
    codigo_cliente_omie: 12345,
    razao_social: 'STAGETEK LTDA',
    cnpj_cpf: '12.345.678/0001-90'
  }

  const parsed = OmieClientSchema.parse(omieResponse)
  expect(parsed.codigo_cliente_omie).toBe(12345)
})

// Testar deduplica√ß√£o por CNPJ
test('n√£o deve criar cliente duplicado', async () => {
  await syncClients()
  await syncClients() // rodar 2x

  const count = await supabase
    .from('clients')
    .select('*', { count: 'exact' })
    .eq('cnpj', '12.345.678/0001-90')

  expect(count).toBe(1)
})
```

### Testes de Integra√ß√£o
- [ ] Sync manual de 50 clientes (deve completar em <2 min)
- [ ] Verificar nenhum cliente duplicado ap√≥s 3 syncs consecutivos
- [ ] Testar com cliente atualizado no Omie (deve refletir no CRM)
- [ ] Testar com Omie API retornando erro 500 (deve registrar em log)

### Testes de Seguran√ßa
- [ ] Usu√°rio n√£o-autenticado n√£o consegue chamar Edge Function (401)
- [ ] Credenciais Omie n√£o vazam em logs ou respostas
- [ ] RLS policies impedem SELECT direto em `omie_sync_map`

---

## üìê Dev Notes

### Autentica√ß√£o Omie

**Estrutura de Requisi√ß√£o Omie**:
```json
{
  "call": "ListarClientes",
  "app_key": "SEU_APP_KEY",
  "app_secret": "SEU_APP_SECRET",
  "param": [{
    "pagina": 1,
    "registros_por_pagina": 50,
    "apenas_importado_api": "N",
    "filtrar_por_data_de": "2025-12-01T00:00:00"
  }]
}
```

**Resposta Omie**:
```json
{
  "pagina": 1,
  "total_de_paginas": 3,
  "registros": 50,
  "total_de_registros": 142,
  "clientes_cadastro": [
    {
      "codigo_cliente_omie": 12345,
      "razao_social": "STAGETEK LTDA",
      "nome_fantasia": "STAGETEK",
      "cnpj_cpf": "12.345.678/0001-90",
      "email": "contato@stagetek.com.br",
      "telefone1_numero": "(11) 98765-4321",
      "endereco": "Av. Paulista, 1000",
      "cidade": "S√£o Paulo",
      "estado": "SP",
      "cep": "01310-100",
      "inativo": "N"
    }
  ]
}
```

### Mapeamento STAGETEK ‚Üî Omie

**Clientes**:
```typescript
const mapOmieToSTAGETEK = (omieClient: OmieClient) => ({
  name: omieClient.nome_fantasia || omieClient.razao_social,
  cnpj: omieClient.cnpj_cpf,
  email: omieClient.email,
  phone: omieClient.telefone1_numero,
  address: {
    street: omieClient.endereco,
    city: omieClient.cidade,
    state: omieClient.estado,
    zipcode: omieClient.cep,
    country: 'Brasil'
  },
  status: omieClient.inativo === 'N' ? 'active' : 'inactive',
  omie_client_id: omieClient.codigo_cliente_omie
})
```

**Produtos**:
```typescript
const mapOmieProductToSTAGETEK = (omieProduct: OmieProduct) => ({
  sku: omieProduct.codigo,
  name: omieProduct.descricao,
  description: omieProduct.descricao_detalhada,
  category: omieProduct.caracteristicas?.categoria || null,
  price_brl: omieProduct.valor_unitario,
  unit: omieProduct.unidade || 'un',
  is_active: omieProduct.inativo === 'N',
  omie_product_id: omieProduct.codigo_produto
})
```

### Edge Function Base URL
```
https://app.omie.com.br/api/v1/
```

**Endpoints usados**:
- Clientes: `POST /geral/clientes/`
- Produtos: `POST /geral/produtos/`

### Pagina√ß√£o
Omie retorna 50 registros por p√°gina. Implementar loop:
```typescript
let pagina = 1
let hasMore = true

while (hasMore) {
  const response = await omieAPI.ListarClientes({ pagina })

  // Processar response.clientes_cadastro

  hasMore = pagina < response.total_de_paginas
  pagina++
}
```

### Sync Incremental
Para evitar processar todos os registros sempre:
```typescript
const lastSync = await getLastSyncTimestamp('clients')

const response = await omieAPI.ListarClientes({
  filtrar_por_data_de: lastSync // ISO 8601
})
```

Omie retorna apenas registros criados/modificados ap√≥s essa data.

### Error Handling
```typescript
try {
  const response = await fetch(OMIE_API_URL, {
    method: 'POST',
    body: JSON.stringify(payload),
    signal: AbortSignal.timeout(30000) // 30s timeout
  })

  if (!response.ok) {
    throw new Error(`Omie API error: ${response.status}`)
  }

  const data = await response.json()

  // Omie retorna erros assim:
  if (data.faultstring) {
    throw new Error(`Omie: ${data.faultstring} (${data.faultcode})`)
  }

  return OmieClientListSchema.parse(data) // Valida√ß√£o Zod

} catch (error) {
  await logSyncError('clients', error.message)
  throw error
}
```

### Transa√ß√µes SQL
Para garantir atomicidade:
```sql
BEGIN;

-- Upsert clientes
INSERT INTO clients (name, cnpj, ..., omie_client_id)
VALUES ($1, $2, ..., $10)
ON CONFLICT (cnpj) DO UPDATE SET
  name = EXCLUDED.name,
  email = EXCLUDED.email,
  updated_at = NOW();

-- Salvar mapeamento
INSERT INTO omie_sync_map (entity_type, stagetek_id, omie_id)
VALUES ('client', $1, $2)
ON CONFLICT (entity_type, omie_id) DO NOTHING;

-- Registrar log
INSERT INTO omie_sync_log (entity_type, status, records_synced)
VALUES ('clients', 'success', 42);

COMMIT;
```

---

## üîó Dependencies

### Bloqueadores
- ‚ö†Ô∏è **Credenciais Omie**: Necess√°rio obter App Key + Secret
- ‚ö†Ô∏è **Sandbox Omie**: Ambiente de testes para valida√ß√£o

### T√©cnicas
- ‚úÖ Supabase Edge Functions (j√° configurado)
- ‚úÖ Tabelas `clients` e `products` (j√° existem)
- ‚è≥ Novas tabelas `omie_sync_map` e `omie_sync_log`

### Relacionadas
- Story 6.2: Sync Autom√°tico (depende desta story)
- Story 6.3: Cota√ß√µes ‚Üí Pedidos (depende de produtos sincronizados)

---

## üìä Definition of Done (DoD)

- [x] C√≥digo segue Protocol Notecraft‚Ñ¢
  - [ ] `OmieSyncButton` ‚â§ 30 linhas (atom)
  - [ ] TypeScript strict mode (zero `any`)
  - [ ] Mobile-first (bot√£o responsivo)
- [ ] Testes passando
  - [ ] Edge Functions testadas com Postman
  - [ ] Sync manual de 10+ clientes reais
  - [ ] Zero duplicatas ap√≥s 3 syncs
- [ ] Documenta√ß√£o completa
  - [ ] README atualizado com instru√ß√µes
  - [ ] Coment√°rios em c√≥digo complexo
- [ ] Code review aprovado
- [ ] Deployed em Supabase production
- [ ] Demonstra√ß√£o funcional para stakeholders

---

## üé¨ Demo Script (Apresenta√ß√£o)

**Cen√°rio**: Vendedor precisa atualizar lista de clientes

**Passos**:
1. Acessar p√°gina `/clientes`
2. Clicar em "‚ü≥ Sincronizar com Omie"
3. Aguardar ~30 segundos (loading spinner)
4. Toast mostra "42 clientes sincronizados com sucesso"
5. Lista de clientes atualiza automaticamente
6. Verificar cliente novo apareceu na lista
7. Verificar cliente existente teve dados atualizados

**Valida√ß√£o**:
- Tempo total < 2 minutos
- Zero erros vis√≠veis ao usu√°rio
- Dados 100% corretos (comparar com Omie)

---

## üìù Notas Adicionais

### Limita√ß√µes do MVP
- ‚úÖ Sync **manual** (bot√£o) - automa√ß√£o na Story 6.2
- ‚úÖ Sync **unidirecional** (Omie ‚Üí STAGETEK) - bidirecional na Story 6.4
- ‚úÖ Apenas **clientes e produtos** - oportunidades na Story 6.4

### Melhorias Futuras (Fora do Escopo)
- ‚è≥ Webhook em tempo real (substituir polling)
- ‚è≥ Sincroniza√ß√£o seletiva (checkbox por cliente)
- ‚è≥ Preview de mudan√ßas antes de aplicar
- ‚è≥ Hist√≥rico de sincroniza√ß√µes com diff

---

**Story criada por**: James (Full Stack Developer)
**Data**: 12 de Dezembro de 2025
**Status**: Draft - Aguardando aprova√ß√£o stakeholder
**Pr√≥xima a√ß√£o**: Valida√ß√£o comercial com Omie + obter credenciais sandbox
