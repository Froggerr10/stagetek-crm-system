# Story 5.3: Busca Global

**Epic**: EPIC-5 - Features de Alto Impacto (P1)
**RICE Score**: 13.3 (Reach: 5 | Impact: 8 | Confidence: 100% | Effort: 3 dias)
**Prioridade**: P1 (Alta)
**Estimativa**: 3 dias
**Status**: ğŸŸ¡ Planejado

---

## ğŸ“‹ User Story

```gherkin
As a: UsuÃ¡rio STAGETEK (qualquer perfil: vendedor, gerente, admin)
I want to: Buscar qualquer entidade (cliente, oportunidade, cotaÃ§Ã£o) de qualquer pÃ¡gina
So that: Eu navegue rapidamente sem perder contexto (vs navegar 3 pÃ¡ginas diferentes)

Context: Atualmente o usuÃ¡rio precisa:
         - Ir em /clientes â†’ buscar cliente especÃ­fico
         - Ir em /oportunidades â†’ buscar oportunidade
         - Ir em /cotacoes â†’ buscar cotaÃ§Ã£o
         Busca global elimina essa fricÃ§Ã£o com shortcut Ctrl+K (padrÃ£o moderno).
```

---

## ğŸ¯ Objetivos

### Objetivo Principal
Implementar SearchBar global no TopBar com shortcut Ctrl+K, buscando em 3 entidades (clients, opportunities, quotations).

### Objetivos SecundÃ¡rios
- Modal full-screen mobile (padrÃ£o CMD+K do Linear, Notion)
- Highlight de match (bold no texto encontrado)
- NavegaÃ§Ã£o por teclado (setas + Enter)
- Debounce 300ms (evitar queries excessivas)

---

## âœ… Acceptance Criteria

### AC-1: SearchBar no TopBar (Desktop)
```gherkin
Given: Estou em qualquer pÃ¡gina (Dashboard, Clientes, Funil, etc)
When: Olho para o TopBar
Then: Vejo campo de busca com Ã­cone ğŸ” e placeholder "Buscar... (Ctrl+K)"
And: Campo tem width: 320px (desktop), full-width (mobile)
And: Foco no campo: border-red-600 (STAGETEK brand)
```

### AC-2: Shortcut Ctrl+K (Desktop) e Cmd+K (Mac)
```gherkin
Given: Estou em qualquer pÃ¡gina
When: Pressiono Ctrl+K (Windows/Linux) ou Cmd+K (Mac)
Then: SearchModal abre (full-screen overlay)
And: Foco automÃ¡tico no input de busca
And: ESC fecha o modal

When: Pressiono Ctrl+K novamente (com modal aberto)
Then: Modal fecha (toggle)
```

### AC-3: Busca em 3 Entidades
```gherkin
Given: SearchModal estÃ¡ aberto
When: Digito "ABC"
Then: Vejo resultados agrupados:
      â”Œâ”€ CLIENTES (2) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚ ABC Eventos Ltda       â”‚
      â”‚ ABC Som e Luz          â”‚
      â”œâ”€ OPORTUNIDADES (3) â”€â”€â”€â”€â”¤
      â”‚ Pedido ABC - Set Luz   â”‚
      â”‚ OrÃ§amento ABC - Palco  â”‚
      â”‚ ABC - Festival 2025    â”‚
      â”œâ”€ COTAÃ‡Ã•ES (1) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
      â”‚ QT-202510-001 - ABC    â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
And: Busca em: name (clientes), title (oportunidades), quotation_number (cotaÃ§Ãµes)
And: Case-insensitive (ABC = abc = Abc)
```

### AC-4: Highlight de Match
```gherkin
Given: Busquei por "ABC"
When: Vejo resultado "ABC Eventos Ltda"
Then: "ABC" estÃ¡ em bold/vermelho (highlight)
And: Resto do texto normal

When: Busquei por "Pedido"
Then: "Pedido" no tÃ­tulo da oportunidade estÃ¡ highlighted
```

### AC-5: NavegaÃ§Ã£o por Teclado
```gherkin
Given: SearchModal aberto com 5 resultados
When: Pressiono â†“ (seta baixo)
Then: Primeiro resultado fica selecionado (bg-red-50)
And: Pressiono â†“ novamente â†’ segundo resultado selecionado
And: Pressiono â†‘ (seta cima) â†’ volta para primeiro

When: Resultado selecionado e pressiono Enter
Then: Navego para pÃ¡gina daquele item
And: Modal fecha automaticamente

When: Pressiono ESC
Then: Modal fecha sem navegar
```

### AC-6: Click no Resultado
```gherkin
Given: Resultado "Pedido ABC - Set Luz" (oportunidade)
When: Clico no resultado
Then: Navego para /oportunidades/:id/detalhes
And: Modal fecha

Given: Resultado "ABC Eventos Ltda" (cliente)
When: Clico no resultado
Then: Navego para /clientes (com filtro aplicado ou detalhes, TBD)
And: Modal fecha

Given: Resultado "QT-202510-001" (cotaÃ§Ã£o)
When: Clico no resultado
Then: Navego para /cotacoes (com filtro aplicado)
And: Modal fecha
```

### AC-7: Debounce 300ms
```gherkin
Given: SearchModal aberto
When: Digito "A"
Then: Query NÃƒO Ã© executada imediatamente
And: Aguardo 300ms â†’ query executada
And: Digito "B" antes de 300ms â†’ reset timer
And: Query final executada para "AB" (300ms apÃ³s Ãºltimo keystroke)
```

### AC-8: Estados Vazios e Loading
```gherkin
Given: SearchModal aberto, input vazio
When: NÃ£o digitei nada ainda
Then: Vejo mensagem: "Digite para buscar clientes, oportunidades, cotaÃ§Ãµes"
And: Ãcones das 3 entidades (ilustraÃ§Ã£o)

Given: Busquei por "XYZABC123"
When: Nenhum resultado encontrado
Then: Vejo: "Nenhum resultado para 'XYZABC123'"
And: SugestÃ£o: "Tente termos diferentes"

Given: Busca em andamento (300ms debounce)
When: Query sendo executada
Then: Vejo loading spinner + "Buscando..."
```

### AC-9: Mobile Full-Screen Modal
```gherkin
Given: Dispositivo mobile (<768px)
When: Clico no Ã­cone ğŸ” no TopBar (sem input desktop)
Then: SearchModal abre em full-screen (100vh)
And: Input ocupa topo com botÃ£o "Cancelar"
And: Resultados scrollÃ¡veis abaixo
And: Teclado virtual abre automaticamente (autofocus)
```

---

## ğŸ—ï¸ Arquitetura de Componentes

### Atomic Design (Protocol Notecraftâ„¢)

#### **TopBar** (Organism - modificar existente)
```
src/components/organisms/TopBar.tsx (adicionar SearchBar)
â”œâ”€ Logo
â”œâ”€ NavegaÃ§Ã£o: Dashboard, Clientes, Oportunidades, Funil
â”œâ”€ SearchBar molecule (desktop) ou SearchIcon (mobile) â† NOVO
â””â”€ UserMenu
```

#### **Molecules** (35 linhas max)
```
src/components/molecules/SearchBar.tsx (32 linhas) - Desktop
â”œâ”€ Input com Ã­cone Search (Lucide)
â”œâ”€ Placeholder: "Buscar... (Ctrl+K)"
â”œâ”€ onClick: abre SearchModal
â”œâ”€ Estilo: border rounded-lg, focus:border-red-600
â””â”€ Mobile: hidden (usa apenas Ã­cone ğŸ”)

src/components/molecules/SearchResult.tsx (28 linhas)
â”œâ”€ Props: result (Client | Opportunity | Quotation), query (string)
â”œâ”€ Layout:
â”‚   â”œâ”€ Ãcone (Building2, Briefcase, FileText)
â”‚   â”œâ”€ TÃ­tulo com highlight (bold no match)
â”‚   â”œâ”€ SubtÃ­tulo (cliente, valor, data)
â”‚   â””â”€ Badge (tipo: Cliente, Oportunidade, CotaÃ§Ã£o)
â”œâ”€ Keyboard nav: isSelected prop (bg-red-50)
â””â”€ onClick: navigate + close modal

src/components/molecules/SearchResultsGroup.tsx (22 linhas)
â”œâ”€ Props: title ("CLIENTES"), results[], query
â”œâ”€ Layout:
â”‚   â”œâ”€ Header: tÃ­tulo + count badge
â”‚   â””â”€ Map results â†’ SearchResult
â””â”€ Separator entre grupos
```

#### **Organisms** (50 linhas max)
```
src/components/organisms/SearchModal.tsx (50 linhas)
â”œâ”€ shadcn Dialog (full-screen mobile)
â”œâ”€ Input de busca (autofocus)
â”œâ”€ useGlobalSearch hook (debounce + query)
â”œâ”€ Results: Map groups â†’ SearchResultsGroup
â”œâ”€ Keyboard nav: useKeyboardNav hook
â”œâ”€ ESC to close, Enter to navigate
â””â”€ Loading state, empty state
```

#### **Hooks**
```
src/hooks/useGlobalSearch.ts (65 linhas)
â”œâ”€ State: query, results, isLoading, error
â”œâ”€ useDebounce(query, 300ms)
â”œâ”€ Query Supabase:
â”‚   â”œâ”€ clients.name ILIKE %query%
â”‚   â”œâ”€ opportunities.title ILIKE %query%
â”‚   â””â”€ quotations.quotation_number ILIKE %query%
â”œâ”€ Limit: 5 results per type (15 total)
â””â”€ Return: { clients, opportunities, quotations, isLoading }

src/hooks/useKeyboardNav.ts (45 linhas)
â”œâ”€ State: selectedIndex (0...results.length-1)
â”œâ”€ Handlers:
â”‚   â”œâ”€ onArrowDown: selectedIndex++
â”‚   â”œâ”€ onArrowUp: selectedIndex--
â”‚   â”œâ”€ onEnter: navigate to selectedResult
â”‚   â””â”€ onEscape: close modal
â””â”€ useEffect: add/remove keyboard listeners
```

---

## ğŸ—‚ï¸ Database & Schema

### Query Principal (Supabase)
```typescript
// src/hooks/useGlobalSearch.ts
const searchClients = async (query: string) => {
  return await supabase
    .from('clients')
    .select('id, name, email, status')
    .ilike('name', `%${query}%`)
    .eq('status', 'active')
    .limit(5);
};

const searchOpportunities = async (query: string) => {
  return await supabase
    .from('opportunities')
    .select('id, title, value, client:clients(name)')
    .ilike('title', `%${query}%`)
    .eq('status', 'open')
    .limit(5);
};

const searchQuotations = async (query: string) => {
  return await supabase
    .from('quotations')
    .select('id, quotation_number, total, opportunity:opportunities(title)')
    .ilike('quotation_number', `%${query}%`)
    .limit(5);
};

// Execute em paralelo
const [clients, opportunities, quotations] = await Promise.all([
  searchClients(query),
  searchOpportunities(query),
  searchQuotations(query)
]);
```

### Full-Text Search (Futuro - P2)
```sql
-- Upgrade para busca mais avanÃ§ada (Sprint 2+)
-- GIN index para full-text search (PostgreSQL)
CREATE INDEX idx_clients_name_gin
  ON clients USING gin(to_tsvector('portuguese', name));

CREATE INDEX idx_opportunities_title_gin
  ON opportunities USING gin(to_tsvector('portuguese', title));

-- Query com full-text (vs ILIKE)
SELECT * FROM clients
WHERE to_tsvector('portuguese', name) @@ to_tsquery('portuguese', 'ABC');
```

---

## ğŸ“‹ Tasks TÃ©cnicos (Checklist)

### Dia 1: SearchBar e Modal BÃ¡sico (8h)
- [ ] **Task 1.1**: Modificar `TopBar.tsx` (adicionar SearchBar)
  - [ ] Importar SearchBar molecule
  - [ ] PosiÃ§Ã£o: centro, entre Nav e UserMenu
  - [ ] Mobile: substituir por Ã­cone Search (Lucide)
- [ ] **Task 1.2**: Criar molecule `SearchBar.tsx` (32 linhas)
  - [ ] Input com placeholder "Buscar... (Ctrl+K)"
  - [ ] Ãcone Search Ã  esquerda
  - [ ] onClick: open SearchModal
  - [ ] Estilo: w-80 desktop, hidden mobile
- [ ] **Task 1.3**: Criar organism `SearchModal.tsx` (50 linhas)
  - [ ] shadcn Dialog component
  - [ ] Full-screen mobile, centered desktop
  - [ ] Input autofocus
  - [ ] Keyboard listener: Ctrl+K to toggle
- [ ] **Task 1.4**: Criar hook `useGlobalSearch.ts` (65 linhas)
  - [ ] State: query, results (clients, opportunities, quotations), isLoading
  - [ ] useDebounce(query, 300ms)
  - [ ] 3 queries Supabase (parallel with Promise.all)
- [ ] **Task 1.5**: Implementar debounce
  ```typescript
  const debouncedQuery = useDebounce(query, 300);
  useEffect(() => {
    if (debouncedQuery) fetchResults(debouncedQuery);
  }, [debouncedQuery]);
  ```

### Dia 2: Resultados e Highlight (8h)
- [ ] **Task 2.1**: Criar molecule `SearchResultsGroup.tsx` (22 linhas)
  - [ ] Props: title ("CLIENTES"), results[], query
  - [ ] Header: tÃ­tulo + Badge com count
  - [ ] Map results â†’ SearchResult
- [ ] **Task 2.2**: Criar molecule `SearchResult.tsx` (28 linhas)
  - [ ] Props: result, query, isSelected
  - [ ] Layout: Ã­cone + tÃ­tulo/subtÃ­tulo + badge tipo
  - [ ] onClick: navigate + close modal
  - [ ] isSelected: bg-red-50 (keyboard nav)
- [ ] **Task 2.3**: Implementar highlight function
  ```typescript
  const highlightMatch = (text: string, query: string) => {
    const parts = text.split(new RegExp(`(${query})`, 'gi'));
    return parts.map((part, i) =>
      part.toLowerCase() === query.toLowerCase()
        ? <mark key={i} className="font-bold text-red-600">{part}</mark>
        : part
    );
  };
  ```
- [ ] **Task 2.4**: Estados vazios e loading
  - [ ] Empty state: "Digite para buscar..."
  - [ ] No results: "Nenhum resultado para 'XYZ'"
  - [ ] Loading: Spinner + "Buscando..."
- [ ] **Task 2.5**: Ãcones por tipo
  - [ ] Cliente: Building2 (Lucide)
  - [ ] Oportunidade: Briefcase (Lucide)
  - [ ] CotaÃ§Ã£o: FileText (Lucide)

### Dia 3: Keyboard Nav e Refinamentos (8h)
- [ ] **Task 3.1**: Criar hook `useKeyboardNav.ts` (45 linhas)
  - [ ] State: selectedIndex
  - [ ] Handlers: ArrowDown, ArrowUp, Enter, Escape
  - [ ] useEffect: addEventListener, removeEventListener
- [ ] **Task 3.2**: Integrar keyboard nav no SearchModal
  - [ ] Passar isSelected para SearchResult
  - [ ] Scroll automÃ¡tico para item selecionado (scrollIntoView)
- [ ] **Task 3.3**: NavegaÃ§Ã£o por tipo
  - [ ] Cliente: /clientes?highlight={id} (TBD, pode ser detalhes futuro)
  - [ ] Oportunidade: /oportunidades/{id}/detalhes
  - [ ] CotaÃ§Ã£o: /cotacoes?highlight={id}
- [ ] **Task 3.4**: Mobile full-screen
  - [ ] Dialog: className="h-screen" em mobile
  - [ ] Input: autofocus + botÃ£o "Cancelar"
  - [ ] Resultados: scrollÃ¡veis (max-h-[70vh])
- [ ] **Task 3.5**: Ctrl+K global shortcut
  - [ ] useEffect no App.tsx ou layout root
  - [ ] Listener: keydown event, check Ctrl+K ou Cmd+K
  - [ ] Toggle SearchModal (Zustand store ou context)
- [ ] **Task 3.6**: Testes manuais
  - [ ] Buscar "ABC" â†’ ver 3 grupos (clientes, opp, cotaÃ§Ãµes)
  - [ ] Keyboard nav: â†“â†‘ funciona, Enter navega
  - [ ] Highlight funciona (match em bold)
  - [ ] Mobile: modal full-screen, teclado abre
  - [ ] Debounce: nÃ£o query instantÃ¢nea

---

## ğŸ¨ UI/UX Specifications

### SearchBar no TopBar (Desktop)
```tsx
// src/components/molecules/SearchBar.tsx
<div
  className="relative w-80 cursor-pointer"
  onClick={() => setSearchModalOpen(true)}
>
  <Search className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground" />
  <Input
    readOnly
    placeholder="Buscar... (Ctrl+K)"
    className="pl-10 pr-4 bg-gray-50 border-gray-200 focus:border-red-600"
  />
  <kbd className="absolute right-3 top-1/2 -translate-y-1/2 text-xs text-muted-foreground">
    Ctrl+K
  </kbd>
</div>
```

### SearchModal Layout
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ”  Buscar em clientes, oportunidades  â”‚ â† Input autofocus
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  CLIENTES (2)                 [badge]   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ğŸ¢ ABC Eventos Ltda               â”‚  â”‚ â† isSelected (bg-red-50)
â”‚  â”‚    contato@abc.com â€¢ Ativo        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ğŸ¢ ABC Som e Luz                  â”‚  â”‚
â”‚  â”‚    abc@som.com â€¢ Ativo            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                          â”‚
â”‚  OPORTUNIDADES (3)            [badge]   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ğŸ’¼ Pedido ABC - Set Luz           â”‚  â”‚
â”‚  â”‚    ABC Eventos â€¢ R$ 12.000,00     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ğŸ’¼ OrÃ§amento ABC - Palco          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  ...                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### SearchResult Design
```tsx
// src/components/molecules/SearchResult.tsx
<div
  className={cn(
    "p-3 rounded-lg cursor-pointer transition-colors",
    "hover:bg-gray-50",
    isSelected && "bg-red-50 border border-red-200"
  )}
  onClick={handleClick}
>
  <div className="flex items-start gap-3">
    {/* Ãcone */}
    <div className="mt-1">
      {type === 'client' && <Building2 className="h-5 w-5 text-blue-600" />}
      {type === 'opportunity' && <Briefcase className="h-5 w-5 text-green-600" />}
      {type === 'quotation' && <FileText className="h-5 w-5 text-purple-600" />}
    </div>

    {/* Content */}
    <div className="flex-1 min-w-0">
      <h4 className="font-semibold text-sm truncate">
        {highlightMatch(title, query)}
      </h4>
      <p className="text-xs text-muted-foreground truncate">
        {subtitle}
      </p>
    </div>

    {/* Badge tipo */}
    <Badge variant="secondary" className="text-xs">
      {type}
    </Badge>
  </div>
</div>
```

### Mobile Full-Screen Modal
```tsx
// Mobile (Tailwind responsive)
<Dialog open={isOpen} onOpenChange={setIsOpen}>
  <DialogContent className="sm:max-w-2xl h-screen sm:h-auto p-0">
    {/* Header com input */}
    <div className="sticky top-0 bg-white border-b p-4">
      <div className="flex items-center gap-2">
        <Search className="h-5 w-5 text-muted-foreground" />
        <Input
          autoFocus
          placeholder="Buscar..."
          className="border-none focus:ring-0"
        />
        <Button variant="ghost" size="sm" onClick={close}>
          Cancelar
        </Button>
      </div>
    </div>

    {/* Results scrollÃ¡veis */}
    <div className="overflow-y-auto max-h-[calc(100vh-80px)] p-4">
      {/* SearchResultsGroups */}
    </div>
  </DialogContent>
</Dialog>
```

### Cores e Tokens
- **Highlight**: font-bold text-red-600
- **Selected item**: bg-red-50 border-red-200
- **Icons**: blue (cliente), green (oportunidade), purple (cotaÃ§Ã£o)
- **Shortcut badge**: kbd element, gray-200 bg

---

## ğŸ§ª Testing Strategy

### Testes Manuais (Checklist QA)
```gherkin
# Happy Path
[ ] SearchBar visÃ­vel no TopBar (desktop)
[ ] Ãcone ğŸ” visÃ­vel no TopBar (mobile)
[ ] Ctrl+K abre SearchModal (desktop)
[ ] Click no SearchBar abre SearchModal
[ ] Buscar "ABC" â†’ resultados em 3 grupos (clientes, opp, cotaÃ§Ãµes)
[ ] Highlight funciona ("ABC" em bold vermelho)
[ ] Keyboard nav: â†“ seleciona prÃ³ximo, â†‘ anterior
[ ] Enter navega para item selecionado, modal fecha
[ ] ESC fecha modal sem navegar
[ ] Click em resultado â†’ navega e fecha

# Edge Cases
[ ] Busca vazia â†’ "Digite para buscar..."
[ ] Busca sem resultado â†’ "Nenhum resultado para 'XYZ'"
[ ] Debounce: digitar rÃ¡pido "ABCDE" â†’ apenas 1 query (300ms)
[ ] Mobile: modal full-screen, teclado abre
[ ] Mobile: botÃ£o "Cancelar" fecha modal
[ ] Query com caracteres especiais (#, @, %) â†’ nÃ£o quebra
[ ] Query muito longa (>50 chars) â†’ truncate
```

### Testes Automatizados (Futuro - Sprint 2)
```typescript
// tests/search.spec.ts (Playwright)
test('should open search modal with Ctrl+K', async ({ page }) => {
  await page.goto('/dashboard');
  await page.keyboard.press('Control+K');
  await expect(page.locator('role=dialog')).toBeVisible();
});

test('should search and display results', async ({ page }) => {
  await page.goto('/dashboard');
  await page.keyboard.press('Control+K');
  await page.fill('input[placeholder*="Buscar"]', 'ABC');
  await page.waitForTimeout(350); // debounce
  await expect(page.locator('text=CLIENTES')).toBeVisible();
  await expect(page.locator('text=ABC Eventos')).toBeVisible();
});

test('should navigate with keyboard', async ({ page }) => {
  await page.goto('/dashboard');
  await page.keyboard.press('Control+K');
  await page.fill('input', 'ABC');
  await page.waitForTimeout(350);
  await page.keyboard.press('ArrowDown'); // select first
  await page.keyboard.press('Enter'); // navigate
  await expect(page).toHaveURL(/\/clientes|\/oportunidades/);
});
```

---

## ğŸ“Š MÃ©tricas de Sucesso

### MÃ©tricas de Produto
- **AdoÃ§Ã£o**: 50+ buscas/dia (5 usuÃ¡rios Ã— 10 buscas/dia)
- **Velocidade**: <3s para encontrar qualquer entidade (vs 30s navegando)
- **Shortcut usage**: 70% das buscas via Ctrl+K (vs click no SearchBar)

### MÃ©tricas de Performance
- **Query Time**: <200ms (3 queries paralelas)
- **Debounce**: 300ms (nÃ£o query instantÃ¢nea)
- **Modal Open**: <100ms (smooth animation)

### MÃ©tricas de Qualidade
- **Protocol Notecraftâ„¢**: 100% (molecules â‰¤35 linhas)
- **TypeScript**: Zero `any`
- **Acessibilidade**: WCAG AA (keyboard nav, ARIA labels)
- **Mobile**: Touch-friendly, teclado virtual funcional

---

## ğŸ”— DependÃªncias

### Depende de (Bloqueadores)
- âœ… Sprint 0: Database + RLS (COMPLETO - 29 Out)
- âœ… TopBar component (EXISTE - implementado 23 Out)
- âœ… Tables: clients, opportunities, quotations (EXISTEM)

### Habilita (PrÃ³ximas Stories)
- Story X: Busca avanÃ§ada com filtros (Sprint 2+)
- Story X: Full-Text Search com GIN indexes (Sprint 2+)
- Story X: Recent searches history (Sprint 2+)

---

## âš ï¸ Riscos e MitigaÃ§Ãµes

### Risco 1: Performance com Muitos Dados
**Impacto**: MÃ©dio (query lenta com 10k+ registros)
**MitigaÃ§Ã£o**:
- Limitar a 5 resultados por tipo (15 total)
- Ãndices ILIKE jÃ¡ existem (B-tree)
- Upgrade futuro: GIN indexes (full-text search)

### Risco 2: Debounce UX (Feels Laggy)
**Impacto**: Baixo (usuÃ¡rios esperam 300ms)
**MitigaÃ§Ã£o**:
- Mostrar loading indicator ("Buscando...")
- Se necessÃ¡rio, reduzir para 200ms
- A/B test com usuÃ¡rios reais

### Risco 3: Keyboard Nav Conflicts
**Impacto**: Baixo (Ctrl+K conflita com browser?)
**MitigaÃ§Ã£o**:
- preventDefault no event listener
- Documentar shortcut na UI (kbd badge)
- Fallback: sempre pode clicar no SearchBar

---

## ğŸ“š ReferÃªncias

### DocumentaÃ§Ã£o
- `docs/prd/epic-5-features-alto-impacto.md` - Epic parent
- `docs/architecture/database-schema.md` - Schema 3 tables
- `src/components/organisms/TopBar.tsx` - Existing component to modify

### Benchmarks UX
- Linear: Cmd+K search (referÃªncia padrÃ£o-ouro)
- Notion: Global search com highlight
- GitHub: Repository search (keyboard nav)
- Slack: Quick switcher (Ctrl+K)

### Libraries
- useDebounce: https://usehooks-ts.com/react-hook/use-debounce
- shadcn Dialog: https://ui.shadcn.com/docs/components/dialog
- Lucide Icons: https://lucide.dev/icons/

---

**Ãšltima atualizaÃ§Ã£o**: 29 de Outubro de 2025 - Sprint 1 planejamento
