# Story 5.2: Funil Kanban React

**Epic**: EPIC-5 - Features de Alto Impacto (P1)
**RICE Score**: 20.0 (Reach: 5 | Impact: 10 | Confidence: 80% | Effort: 2 dias)
**Prioridade**: P1 (Alta)
**Estimativa**: 2 dias
**Status**: ğŸŸ¡ Planejado

---

## ğŸ“‹ User Story

```gherkin
As a: Gerente Comercial STAGETEK
I want to: Visualizar pipeline em Kanban com drag-and-drop mobile-friendly
So that: Eu atualize estÃ¡gios rapidamente e veja totalizadores R$ por coluna

Context: Atualmente existe HTML standalone (pages/funil-vendas.html) nÃ£o integrado
         ao React. NavegaÃ§Ã£o estÃ¡ quebrada (clique em card nÃ£o abre detalhes).
         NecessÃ¡rio migraÃ§Ã£o completa para React com real-time updates.
```

---

## ğŸ¯ Objetivos

### Objetivo Principal
Migrar Kanban HTML â†’ React com drag-and-drop (dnd-kit), real-time updates (Zustand), e navegaÃ§Ã£o funcional.

### Objetivos SecundÃ¡rios
- Deletar `pages/funil-vendas.html` apÃ³s migraÃ§Ã£o completa
- Integrar com TopBar (navegaÃ§Ã£o Dashboard â†’ Funil funcionando)
- Mobile-first: touch gestures, swipe para mover cards

---

## âœ… Acceptance Criteria

### AC-1: Layout Kanban BÃ¡sico
```gherkin
Given: Estou logado como usuÃ¡rio STAGETEK
When: Navego para /funil
Then: Vejo 5 colunas verticais (stages configurados)
And: Cada coluna tem header com:
     - Nome do estÃ¡gio (ex: "QualificaÃ§Ã£o")
     - Totalizador R$ (ex: "R$ 45.200,00")
     - Contador de oportunidades (ex: "7 oportunidades")
And: Cards de oportunidades dentro de cada coluna
```

### AC-2: Drag-and-Drop Desktop
```gherkin
Given: Vejo card "Pedido Set Luz" na coluna "QualificaÃ§Ã£o"
When: Arrasto o card para coluna "Proposta"
Then: Card se move visualmente (animaÃ§Ã£o suave)
And: Solto o mouse â†’ card permanece na nova coluna
And: Backend atualiza: UPDATE opportunities SET stage_id = {nova_stage}
And: Totalizadores recalculam (coluna origem -R$, destino +R$)
And: Toast de sucesso: "Oportunidade movida para Proposta"
```

### AC-3: Drag-and-Drop Mobile (Touch)
```gherkin
Given: Estou em dispositivo mobile (touch)
When: Toque longo (long-press) no card "Pedido Set Luz"
Then: Card "levanta" (visual feedback: shadow, scale)
And: Arrasto com dedo para coluna "Proposta"
And: Solto â†’ card move para nova coluna
And: Mesma lÃ³gica de update backend + toast
```

### AC-4: Real-time Updates (Zustand)
```gherkin
Given: Dois usuÃ¡rios (A e B) visualizando /funil simultaneamente
When: UsuÃ¡rio A arrasta card "Pedido ABC" para "NegociaÃ§Ã£o"
Then: UsuÃ¡rio B vÃª o card mover automaticamente (sem refresh)
And: Totalizadores atualizam em tempo real para ambos
And: Implementado via Zustand + Supabase Realtime subscriptions
```

### AC-5: Click no Card â†’ Detalhes
```gherkin
Given: Card "Pedido Set Luz" na coluna "QualificaÃ§Ã£o"
When: Clico no card (nÃ£o arrasto)
Then: Navego para /oportunidades/:id/detalhes
And: Modal abre (ou pÃ¡gina, dependendo do Epic 2 implementado)
And: Vejo detalhes completos da oportunidade
```

### AC-6: Filtros no Kanban
```gherkin
Given: Estou na pÃ¡gina /funil
When: Abro dropdown "Filtros"
Then: Vejo opÃ§Ãµes:
     - Todas as oportunidades (default)
     - Minhas oportunidades (assigned_to = current_user)
     - Por responsÃ¡vel (select user)
When: Seleciono "Minhas oportunidades"
Then: Kanban mostra apenas oportunidades onde sou responsÃ¡vel
And: Totalizadores recalculam apenas com oportunidades filtradas
```

### AC-7: Totalizadores Corretos
```gherkin
Given: Coluna "Proposta" tem 3 oportunidades:
       - Pedido A: R$ 12.000,00
       - Pedido B: R$ 8.500,00
       - Pedido C: R$ 15.700,00
When: Carrego /funil
Then: Header da coluna mostra: "R$ 36.200,00 â€¢ 3 oportunidades"
And: Formato moeda brasileiro (R$ X.XXX,XX)
And: Contador atualiza ao arrastar cards
```

### AC-8: Estados Vazios
```gherkin
Given: Coluna "Fechado Ganho" nÃ£o tem oportunidades
When: Visualizo Kanban
Then: Vejo mensagem: "Nenhuma oportunidade neste estÃ¡gio"
And: Ãrea drop-zone ativa (posso arrastar cards para coluna vazia)

Given: Nenhuma oportunidade no sistema
When: Acesso /funil
Then: Vejo: "Nenhuma oportunidade criada. Crie sua primeira!"
And: BotÃ£o CTA: "Nova Oportunidade" â†’ abre modal
```

---

## ğŸ—ï¸ Arquitetura de Componentes

### Atomic Design (Protocol Notecraftâ„¢)

#### **PÃ¡gina** (Template)
```
src/pages/Funil.tsx (28 linhas max)
â”œâ”€ Imports: KanbanBoard organism, TopBar
â”œâ”€ Hook: useFunilPage (Zustand + Supabase subscriptions)
â””â”€ Layout: TopBar + KanbanBoard
```

#### **Organisms** (50 linhas max)
```
src/components/organisms/KanbanBoard.tsx (50 linhas)
â”œâ”€ dnd-kit setup (DndContext, sensors)
â”œâ”€ Map stages â†’ KanbanColumn
â”œâ”€ onDragEnd handler (update backend)
â””â”€ Real-time subscription (Zustand)

src/components/organisms/KanbanColumn.tsx (48 linhas)
â”œâ”€ Props: stage, opportunities[], totalValue
â”œâ”€ Header: ColumnHeader molecule
â”œâ”€ Body: Droppable area (SortableContext)
â”‚   â””â”€ Map opportunities â†’ OpportunityCard
â””â”€ Empty state: "Nenhuma oportunidade"
```

#### **Molecules** (35 linhas max)
```
src/components/molecules/ColumnHeader.tsx (22 linhas)
â”œâ”€ Props: stageName, totalValue, count
â”œâ”€ Display: Nome + Badge count + R$ total
â””â”€ Estilo: sticky top (permanece visÃ­vel ao scroll)

src/components/molecules/OpportunityCard.tsx (34 linhas) - REUTILIZAR do Epic 3
â”œâ”€ Props: opportunity, isDragging
â”œâ”€ Layout: Card compacto
â”‚   â”œâ”€ TÃ­tulo da oportunidade
â”‚   â”œâ”€ Cliente (com avatar iniciais)
â”‚   â”œâ”€ Valor (R$ 12.000,00)
â”‚   â””â”€ Data (hÃ¡ 2 dias)
â”œâ”€ Draggable: useSortable hook (dnd-kit)
â””â”€ Hover: border-red-600, cursor-grab
```

#### **Hooks**
```
src/hooks/useFunilStore.ts (70 linhas) - Zustand store
â”œâ”€ State: stages[], opportunities[], filters
â”œâ”€ Actions:
â”‚   â”œâ”€ moveOpportunity(oppId, newStageId)
â”‚   â”œâ”€ subscribeToOpportunities() // Realtime
â”‚   â””â”€ applyFilters(userId?)
â””â”€ Computed: totalizersByStage

src/hooks/useDragAndDrop.ts (45 linhas)
â”œâ”€ dnd-kit sensors (pointer, touch, keyboard)
â”œâ”€ onDragEnd handler
â””â”€ Optimistic updates (UI first, then backend)
```

---

## ğŸ—‚ï¸ Database & Schema

### Query Principal (Supabase)
```typescript
// src/hooks/useFunilStore.ts
const { data: stages } = await supabase
  .from('funnel_stages')
  .select('*')
  .eq('funnel_id', currentFunnelId)
  .order('order_index');

const { data: opportunities } = await supabase
  .from('opportunities')
  .select(`
    *,
    client:clients(id, name, avatar_url),
    stage:funnel_stages(id, name, color)
  `)
  .eq('status', 'open') // apenas abertas
  .order('created_at', { ascending: false });
```

### Ãndices NecessÃ¡rios (jÃ¡ existem do Sprint 0)
```sql
-- âœ… JÃ EXISTE (Sprint 0):
CREATE INDEX idx_opportunities_status_stage_id
  ON opportunities(status, stage_id);

-- Performance: 8x faster Kanban queries (status + stage)
```

### Real-time Subscription
```typescript
// src/hooks/useFunilStore.ts
supabase
  .channel('opportunities-changes')
  .on('postgres_changes', {
    event: '*', // INSERT, UPDATE, DELETE
    schema: 'public',
    table: 'opportunities'
  }, (payload) => {
    // Update Zustand store
    if (payload.eventType === 'UPDATE') {
      updateOpportunity(payload.new);
    }
  })
  .subscribe();
```

---

## ğŸ“‹ Tasks TÃ©cnicos (Checklist)

### Dia 1: Setup dnd-kit e Layout BÃ¡sico (8h)
- [ ] **Task 1.1**: Instalar dependÃªncias
  ```bash
  npm install @dnd-kit/core @dnd-kit/sortable @dnd-kit/utilities
  ```
- [ ] **Task 1.2**: Criar pÃ¡gina `src/pages/Funil.tsx` (28 linhas)
  - [ ] Importar KanbanBoard
  - [ ] Setup layout: full-height (h-screen)
  - [ ] TopBar + KanbanBoard
- [ ] **Task 1.3**: Criar Zustand store `useFunilStore.ts` (70 linhas)
  - [ ] State: stages, opportunities, filters
  - [ ] Actions: fetchStages, fetchOpportunities, moveOpportunity
  - [ ] Computed: getTotalizersByStage
- [ ] **Task 1.4**: Criar organism `KanbanBoard.tsx` (50 linhas)
  - [ ] DndContext setup (sensors: pointer, touch, keyboard)
  - [ ] Map stages â†’ KanbanColumn
  - [ ] onDragEnd handler (call moveOpportunity)
- [ ] **Task 1.5**: Criar organism `KanbanColumn.tsx` (48 linhas)
  - [ ] Props: stage, opportunities[]
  - [ ] Droppable area (useDroppable hook)
  - [ ] Map opportunities â†’ OpportunityCard (draggable)
- [ ] **Task 1.6**: Criar molecule `ColumnHeader.tsx` (22 linhas)
  - [ ] Display: stage name + count + R$ total
  - [ ] Estilo: bg-gray-50 border-b sticky top-0

### Dia 2: Drag-and-Drop, Real-time e Refinamentos (8h)
- [ ] **Task 2.1**: Implementar hook `useDragAndDrop.ts` (45 linhas)
  - [ ] Sensors: PointerSensor, TouchSensor, KeyboardSensor
  - [ ] onDragEnd: extrair oppId e newStageId
  - [ ] Optimistic update (UI first)
  - [ ] Backend update: supabase.from('opportunities').update()
- [ ] **Task 2.2**: Reutilizar `OpportunityCard.tsx` do Epic 3 (adaptar)
  - [ ] Adicionar useSortable hook (dnd-kit)
  - [ ] Props: isDragging (visual feedback)
  - [ ] Cursor: grab (default), grabbing (dragging)
  - [ ] Onclick: navigate to /oportunidades/:id/detalhes
- [ ] **Task 2.3**: Implementar Real-time subscriptions
  - [ ] Supabase Realtime channel: 'opportunities-changes'
  - [ ] On UPDATE: atualizar oportunidade no Zustand
  - [ ] On INSERT: adicionar nova oportunidade
  - [ ] On DELETE: remover oportunidade
- [ ] **Task 2.4**: Totalizadores dinÃ¢micos
  - [ ] Computed: getTotalizersByStage(stageId) â†’ { total, count }
  - [ ] Formatar moeda: formatCurrency(value) â†’ "R$ 12.000,00"
  - [ ] Atualizar header ao mover cards
- [ ] **Task 2.5**: Filtros bÃ¡sicos
  - [ ] Dropdown no TopBar: "Todas | Minhas | Por responsÃ¡vel"
  - [ ] Filter logic: .eq('assigned_to', currentUserId)
  - [ ] Recalcular totalizadores com filtro ativo
- [ ] **Task 2.6**: Estados vazios
  - [ ] Coluna vazia: "Nenhuma oportunidade neste estÃ¡gio"
  - [ ] Sistema vazio: "Crie sua primeira oportunidade" + CTA
- [ ] **Task 2.7**: Mobile responsiveness
  - [ ] Touch gestures (long-press para arrastar)
  - [ ] Colunas: scroll horizontal em mobile
  - [ ] Cards: full-width em mobile
- [ ] **Task 2.8**: Deletar HTML standalone
  ```bash
  rm pages/funil-vendas.html
  ```
- [ ] **Task 2.9**: Atualizar navegaÃ§Ã£o no TopBar
  - [ ] Link "Oportunidades" â†’ /funil (nÃ£o /oportunidades)
  - [ ] Active state: border-b-2 border-red-600

---

## ğŸ¨ UI/UX Specifications

### Layout Desktop (1024px+)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TopBar (Dashboard | Clientes | Oportunidades | Funil)   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Filtros: [Todas â–¼] [+ Nova Oportunidade]                â”‚
â”œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚Lead â”‚Qualifâ”‚Proposâ”‚Negoc â”‚Ganho                          â”‚
â”‚R$0  â”‚R$45k â”‚R$120kâ”‚R$80k â”‚R$200k                         â”‚
â”‚0    â”‚7     â”‚12    â”‚5     â”‚8                              â”‚
â”œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚     â”‚â”Œâ”€â”€â”€â”€â”â”‚â”Œâ”€â”€â”€â”€â”â”‚â”Œâ”€â”€â”€â”€â”â”‚â”Œâ”€â”€â”€â”€â”                         â”‚
â”‚     â”‚â”‚Ped â”‚â”‚â”‚â”‚Ped â”‚â”‚â”‚â”‚Ped â”‚â”‚â”‚â”‚Ped â”‚                         â”‚
â”‚     â”‚â”‚ABC â”‚â”‚â”‚â”‚XYZ â”‚â”‚â”‚â”‚DEF â”‚â”‚â”‚â”‚GHI â”‚                         â”‚
â”‚     â”‚â”‚12k â”‚â”‚â”‚â”‚8k  â”‚â”‚â”‚â”‚15k â”‚â”‚â”‚â”‚20k â”‚                         â”‚
â”‚     â”‚â””â”€â”€â”€â”€â”˜â”‚â”‚â””â”€â”€â”€â”€â”˜â”‚â”‚â””â”€â”€â”€â”€â”˜â”‚â”‚â””â”€â”€â”€â”€â”˜                         â”‚
â”‚     â”‚      â”‚â”‚      â”‚â”‚      â”‚â”‚                               â”‚
â”‚     â”‚â”Œâ”€â”€â”€â”€â”â”‚â”‚â”Œâ”€â”€â”€â”€â”â”‚â”‚      â”‚â”‚                               â”‚
â”‚     â”‚â”‚... â”‚â”‚â”‚â”‚... â”‚â”‚â”‚â”‚      â”‚â”‚                               â”‚
â”‚     â”‚â””â”€â”€â”€â”€â”˜â”‚â”‚â””â”€â”€â”€â”€â”˜â”‚â”‚      â”‚â”‚                               â”‚
â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Layout Mobile (<768px)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â˜° Funil de Vendas   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [Filtros â–¼]         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â† â†’  (scroll horiz) â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ QualificaÃ§Ã£o  â”‚   â”‚
â”‚ â”‚ R$ 45.200,00  â”‚   â”‚
â”‚ â”‚ 7 oportun.    â”‚   â”‚
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚ â”‚ â”‚ Pedido ABCâ”‚ â”‚   â”‚ â† long-press para arrastar
â”‚ â”‚ â”‚ ABC Ltda  â”‚ â”‚   â”‚
â”‚ â”‚ â”‚ R$ 12.000 â”‚ â”‚   â”‚
â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚ â”‚ â”‚ ...       â”‚ â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### OpportunityCard Design (Kanban)
```tsx
// Visual spec (compacto para Kanban)
<Card
  className="group cursor-grab active:cursor-grabbing hover:border-red-600 transition-all"
  style={{ opacity: isDragging ? 0.5 : 1 }}
>
  <CardHeader className="p-3 space-y-1">
    <h4 className="font-semibold text-sm line-clamp-2">
      {opportunity.title}
    </h4>
    <div className="flex items-center gap-2">
      <Avatar className="h-6 w-6">
        <AvatarFallback>{getInitials(client.name)}</AvatarFallback>
      </Avatar>
      <span className="text-xs text-muted-foreground truncate">
        {client.name}
      </span>
    </div>
  </CardHeader>

  <CardContent className="p-3 pt-0">
    <p className="text-lg font-bold text-red-600">
      {formatCurrency(opportunity.value)}
    </p>
    <p className="text-xs text-muted-foreground">
      hÃ¡ {formatDistanceToNow(opportunity.created_at)}
    </p>
  </CardContent>
</Card>
```

### ColumnHeader Design
```tsx
// Visual spec
<div className="sticky top-0 bg-gray-50 border-b p-3 z-10">
  <h3 className="font-semibold text-sm">{stage.name}</h3>
  <div className="flex items-center gap-2 mt-1">
    <Badge variant="secondary" className="text-xs">
      {count} {count === 1 ? 'oportunidade' : 'oportunidades'}
    </Badge>
    <span className="text-sm font-bold text-red-600">
      {formatCurrency(totalValue)}
    </span>
  </div>
</div>
```

### Cores e Tokens
- **Stages colors**: Usar `funnel_stages.color` (ex: blue-500, green-500)
- **Dragging**: opacity 0.5, scale 1.05, shadow-xl
- **Drop zone**: border-dashed border-2 border-red-600 (on hover)
- **Empty state**: text-muted-foreground, Ã­cone Inbox (Lucide)

---

## ğŸ§ª Testing Strategy

### Testes Manuais (Checklist QA)
```gherkin
# Happy Path
[ ] Carregar /funil â†’ 5 colunas visÃ­veis com headers corretos
[ ] Arrastar card desktop â†’ move para nova coluna, backend atualiza
[ ] Arrastar card mobile (long-press) â†’ move para nova coluna
[ ] Click em card â†’ navega para detalhes da oportunidade
[ ] Totalizadores: valores R$ corretos, contadores corretos
[ ] Filtro "Minhas oportunidades" â†’ mostra apenas minhas
[ ] Real-time: usuÃ¡rio B vÃª mudanÃ§as de usuÃ¡rio A

# Edge Cases
[ ] Coluna vazia â†’ "Nenhuma oportunidade neste estÃ¡gio"
[ ] Sistema vazio â†’ CTA "Criar primeira oportunidade"
[ ] Arrastar para mesma coluna â†’ nÃ£o faz nada
[ ] Perda de conexÃ£o â†’ toast "Reconectando..."
[ ] Mobile: scroll horizontal funciona (5 colunas)
[ ] Mobile: cards full-width, nÃ£o quebram layout
```

### Testes Automatizados (Futuro - Sprint 2)
```typescript
// tests/funil.spec.ts (Playwright)
test('should drag and drop opportunity', async ({ page }) => {
  await page.goto('/funil');
  const card = page.locator('text=Pedido ABC').first();
  const targetColumn = page.locator('text=Proposta').first();

  await card.dragTo(targetColumn);
  await expect(page.locator('text=Oportunidade movida')).toBeVisible();
});

test('should calculate totalizers correctly', async ({ page }) => {
  await page.goto('/funil');
  const header = page.locator('text=QualificaÃ§Ã£o').locator('..');
  await expect(header).toContainText('R$ 45.200,00');
  await expect(header).toContainText('7 oportunidades');
});
```

---

## ğŸ“Š MÃ©tricas de Sucesso

### MÃ©tricas de Produto
- **AdoÃ§Ã£o**: 100% das mudanÃ§as de estÃ¡gio via drag-and-drop (vs 0% hoje)
- **Velocidade**: <2s para mover oportunidade (vs 10s em HTML + reload)
- **NavegaÃ§Ã£o**: 80% dos detalhes acessados via click em card Kanban

### MÃ©tricas de Performance
- **Page Load**: <800ms (inicial, com 50 oportunidades)
- **Drag Performance**: 60fps (smooth animation)
- **Real-time Latency**: <500ms (mudanÃ§a visÃ­vel em outros clientes)

### MÃ©tricas de Qualidade
- **Protocol Notecraftâ„¢**: 100% (organisms â‰¤50 linhas)
- **TypeScript**: Zero `any`
- **Mobile**: Touch gestures funcionais, scroll horizontal suave
- **Acessibilidade**: Keyboard navigation (arrow keys, Enter)

---

## ğŸ”— DependÃªncias

### Depende de (Bloqueadores)
- âœ… Sprint 0: Database + RLS (COMPLETO - 29 Out)
- âœ… Tables: opportunities, funnel_stages (EXISTEM)
- âœ… Ãndices: idx_opportunities_status_stage_id (EXISTE - Sprint 0)
- âœ… TopBar component (EXISTE - implementado 23 Out)

### Habilita (PrÃ³ximas Stories)
- Story 2.1: Barra de Filtros (integra com Kanban)
- Epic 2: Detalhes Oportunidade (navegaÃ§Ã£o Kanban â†’ Detalhes)
- Epic 3: RelatÃ³rios (anÃ¡lise de conversÃ£o por estÃ¡gio)

---

## âš ï¸ Riscos e MitigaÃ§Ãµes

### Risco 1: dnd-kit Performance em Mobile
**Impacto**: Alto (drag-and-drop travando)
**MitigaÃ§Ã£o**:
- Usar sensors otimizados (TouchSensor com delay)
- Limitar a 100 cards por coluna (pagination)
- VirtualizaÃ§Ã£o se necessÃ¡rio (react-window)

### Risco 2: Real-time Conflitos (Two Users)
**Impacto**: MÃ©dio (inconsistÃªncia)
**MitigaÃ§Ã£o**:
- Last-write-wins (PostgreSQL default)
- Toast: "Oportunidade foi movida por outro usuÃ¡rio"
- Revalidar local state ao receber update

### Risco 3: HTML Deletion (Rollback)
**Impacto**: Baixo (usuÃ¡rios dependem do HTML?)
**MitigaÃ§Ã£o**:
- Backup: renomear para `funil-vendas.html.bak`
- Testar React version com usuÃ¡rios reais antes de deletar
- Rollback fÃ¡cil: restaurar HTML se necessÃ¡rio

---

## ğŸ“š ReferÃªncias

### DocumentaÃ§Ã£o
- `docs/prd/epic-5-features-alto-impacto.md` - Epic parent
- `protocol/RD-STATION-UX-DEEP-ANALYSIS.md` - Kanban UX analysis
- `pages/funil-vendas.html` - Current HTML implementation

### Libraries
- dnd-kit: https://docs.dndkit.com/
- Zustand: https://zustand-demo.pmnd.rs/
- Supabase Realtime: https://supabase.com/docs/guides/realtime

### Benchmarks UX
- RD Station CRM: Funil de vendas drag-and-drop
- Trello: Mobile touch gestures (long-press)
- Monday.com: Real-time collaboration

---

**Ãšltima atualizaÃ§Ã£o**: 29 de Outubro de 2025 - Sprint 1 planejamento
