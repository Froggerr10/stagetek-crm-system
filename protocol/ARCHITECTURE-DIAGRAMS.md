# STAGETEK CRM - Architecture Diagrams
**Visual Reference for ARCHITECTURE-VIABILITY-ANALYSIS.md**

**Date**: 24 October 2025
**Version**: 1.0

---

## ğŸ“Š DIAGRAM 1: Current vs Proposed Architecture

```ascii
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CURRENT ARCHITECTURE (V1 - As of Oct 2025)                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚  Funil.tsx   â”‚     â”‚ Oportunidadesâ”‚     â”‚  Clientes    â”‚                  â”‚
â”‚  â”‚              â”‚     â”‚   .tsx       â”‚     â”‚   .tsx       â”‚                  â”‚
â”‚  â”‚ useState()   â”‚     â”‚ useState()   â”‚     â”‚ useState()   â”‚                  â”‚
â”‚  â”‚ useEffect()  â”‚     â”‚ useEffect()  â”‚     â”‚ useEffect()  â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚         â”‚                    â”‚                    â”‚                           â”‚
â”‚         â”‚ fetch()            â”‚ fetch()            â”‚ fetch()                   â”‚
â”‚         â”‚                    â”‚                    â”‚                           â”‚
â”‚         â–¼                    â–¼                    â–¼                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚         Supabase Client (direct queries)                 â”‚                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚         â”‚                    â”‚                    â”‚                           â”‚
â”‚         â–¼                    â–¼                    â–¼                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚              PostgreSQL Database                         â”‚                 â”‚
â”‚  â”‚  clients | opportunities | tasks | products              â”‚                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                                                                                 â”‚
â”‚  PROBLEMS:                                                                     â”‚
â”‚  âŒ Data duplication (each component fetches independently)                   â”‚
â”‚  âŒ No cache (re-fetch on every route change)                                 â”‚
â”‚  âŒ No real-time sync (manual refresh required)                               â”‚
â”‚  âŒ Slow optimistic updates (wait for DB response)                            â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PROPOSED ARCHITECTURE (V2 - With Zustand + Realtime)                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚  Funil.tsx   â”‚     â”‚ Oportunidadesâ”‚     â”‚  Clientes    â”‚                  â”‚
â”‚  â”‚              â”‚     â”‚   .tsx       â”‚     â”‚   .tsx       â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚         â”‚                    â”‚                    â”‚                           â”‚
â”‚         â”‚ useStore()         â”‚ useStore()         â”‚ useStore()                â”‚
â”‚         â”‚                    â”‚                    â”‚                           â”‚
â”‚         â–¼                    â–¼                    â–¼                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚          Zustand Stores (Centralized State)              â”‚                 â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚                 â”‚
â”‚  â”‚  â”‚ Opportunity â”‚  â”‚   Client    â”‚  â”‚    Task     â”‚     â”‚                 â”‚
â”‚  â”‚  â”‚    Store    â”‚  â”‚   Store     â”‚  â”‚   Store     â”‚     â”‚                 â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚                 â”‚
â”‚  â”‚         â”‚                 â”‚                 â”‚            â”‚                 â”‚
â”‚  â”‚         â”‚ Optimistic      â”‚ Optimistic      â”‚ Optimisticâ”‚                 â”‚
â”‚  â”‚         â”‚ Updates         â”‚ Updates         â”‚ Updates   â”‚                 â”‚
â”‚  â”‚         â–¼                 â–¼                 â–¼            â”‚                 â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚                 â”‚
â”‚  â”‚  â”‚      Supabase Client (with Realtime)             â”‚   â”‚                 â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚         â”‚                    â”‚                    â”‚                           â”‚
â”‚         â–¼                    â–¼                    â–¼                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚              PostgreSQL Database                         â”‚                 â”‚
â”‚  â”‚  clients | opportunities | tasks | contacts | sources    â”‚                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚         â”‚                                                                      â”‚
â”‚         â”‚ (Real-time changes broadcasted)                                     â”‚
â”‚         â”‚                                                                      â”‚
â”‚         â–¼                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚         Supabase Realtime (WebSocket)                    â”‚                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚         â”‚                                                                      â”‚
â”‚         â”‚ (All connected clients receive updates)                             â”‚
â”‚         â”‚                                                                      â”‚
â”‚         â–¼                                                                      â”‚
â”‚  [User A's Browser] â—„â”€â”€â–º [User B's Browser] â—„â”€â”€â–º [User C's Browser]          â”‚
â”‚                                                                                 â”‚
â”‚  BENEFITS:                                                                     â”‚
â”‚  âœ… Single source of truth (no duplication)                                   â”‚
â”‚  âœ… Instant UI updates (optimistic)                                           â”‚
â”‚  âœ… Real-time sync across all users                                           â”‚
â”‚  âœ… 3x faster perceived performance                                           â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š DIAGRAM 2: Database Schema Evolution

```ascii
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SCHEMA EVOLUTION: V1 â†’ V2 â†’ V3                                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚ V1 (CURRENT - Oct 2025)                                                        â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                            â”‚
â”‚                                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                              â”‚
â”‚  â”‚   clients    â”‚                                                              â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                    â”‚
â”‚  â”‚ id           â”‚â—„â”€â”€â”€â”€â”‚  opportunities   â”‚                                    â”‚
â”‚  â”‚ name         â”‚     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                                    â”‚
â”‚  â”‚ cnpj         â”‚     â”‚ id               â”‚                                    â”‚
â”‚  â”‚ email  âš ï¸    â”‚     â”‚ client_id (FK)   â”‚                                    â”‚
â”‚  â”‚ phone  âš ï¸    â”‚     â”‚ stage_id (FK)    â”‚                                    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚ value            â”‚                                    â”‚
â”‚                       â”‚ lost_reason âš ï¸   â”‚ (TEXT, unstructured)                â”‚
â”‚                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                    â”‚
â”‚                                                                                 â”‚
â”‚  PROBLEMS:                                                                     â”‚
â”‚  âš ï¸ Only 1 email per client (can't track multiple contacts)                   â”‚
â”‚  âš ï¸ lost_reason is free-text (can't analyze patterns)                         â”‚
â”‚  âš ï¸ No source tracking (can't calculate ROI)                                  â”‚
â”‚                                                                                 â”‚
â”‚                                                                                 â”‚
â”‚ V2 (PHASE 1 - Week 3)                                                          â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                            â”‚
â”‚                                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                            â”‚
â”‚  â”‚ organizations  â”‚ (renamed from clients)                                     â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                  â”‚
â”‚  â”‚ id             â”‚â—„â”€â”€â”€â”€â”‚    contacts      â”‚ âœ… NEW!                           â”‚
â”‚  â”‚ name           â”‚     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                                  â”‚
â”‚  â”‚ cnpj           â”‚     â”‚ id               â”‚                                  â”‚
â”‚  â”‚ website        â”‚     â”‚ organization_id  â”‚ (FK)                              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚ name             â”‚                                  â”‚
â”‚         â–²               â”‚ emails (JSONB)   â”‚ [multiple emails]                 â”‚
â”‚         â”‚               â”‚ phones (JSONB)   â”‚ [multiple phones]                 â”‚
â”‚         â”‚               â”‚ job_title        â”‚                                  â”‚
â”‚         â”‚               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                  â”‚
â”‚         â”‚                        â”‚                                             â”‚
â”‚         â”‚                        â”‚                                             â”‚
â”‚         â”‚               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                  â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚  opportunities   â”‚                                  â”‚
â”‚                         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                                  â”‚
â”‚                         â”‚ id               â”‚                                  â”‚
â”‚                         â”‚ organization_id  â”‚ (FK)                              â”‚
â”‚                         â”‚ contact_ids      â”‚ (JSONB array) âœ… NEW!             â”‚
â”‚                         â”‚ stage_id (FK)    â”‚                                  â”‚
â”‚                         â”‚ value            â”‚                                  â”‚
â”‚                         â”‚ loss_reason_id   â”‚ (FK) âœ… NEW!                      â”‚
â”‚                         â”‚ source_id        â”‚ (FK) âœ… NEW!                      â”‚
â”‚                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                  â”‚
â”‚                                  â”‚                                             â”‚
â”‚                                  â”‚                                             â”‚
â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚          â”‚                       â”‚                       â”‚                    â”‚
â”‚          â–¼                       â–¼                       â–¼                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚ loss_reasons â”‚    â”‚   sources    â”‚      â”‚    stages    â”‚                 â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                 â”‚
â”‚  â”‚ id           â”‚    â”‚ id           â”‚      â”‚ id           â”‚                 â”‚
â”‚  â”‚ name         â”‚    â”‚ name         â”‚      â”‚ name         â”‚                 â”‚
â”‚  â”‚ display_orderâ”‚    â”‚ channel      â”‚      â”‚ pipeline_id  â”‚                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                                                                                 â”‚
â”‚  BENEFITS:                                                                     â”‚
â”‚  âœ… Multiple contacts per organization                                        â”‚
â”‚  âœ… Structured loss reasons (reportable)                                      â”‚
â”‚  âœ… Source attribution (ROI tracking)                                         â”‚
â”‚                                                                                 â”‚
â”‚                                                                                 â”‚
â”‚ V3 (PHASE 2 - Week 6)                                                          â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                            â”‚
â”‚                                                                                 â”‚
â”‚  (All V2 tables) +                                                             â”‚
â”‚                                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                 â”‚
â”‚  â”‚      teams       â”‚     â”‚email_templates â”‚                                 â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                                 â”‚
â”‚  â”‚ id               â”‚     â”‚ id             â”‚                                 â”‚
â”‚  â”‚ name             â”‚     â”‚ name           â”‚                                 â”‚
â”‚  â”‚ manager_id (FK)  â”‚     â”‚ subject        â”‚                                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚ body (HTML)    â”‚                                 â”‚
â”‚                           â”‚ variables      â”‚ (JSONB)                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                 â”‚
â”‚  â”‚  custom_fields   â”‚                                                         â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                 â”‚
â”‚  â”‚ id               â”‚     â”‚  automations   â”‚                                 â”‚
â”‚  â”‚ entity_type      â”‚     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                                 â”‚
â”‚  â”‚ field_name       â”‚     â”‚ id             â”‚                                 â”‚
â”‚  â”‚ field_type       â”‚     â”‚ trigger_type   â”‚                                 â”‚
â”‚  â”‚ field_options    â”‚     â”‚ action_type    â”‚                                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚ is_active      â”‚                                 â”‚
â”‚                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                 â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š DIAGRAM 3: RLS Policy Architecture

```ascii
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ROW LEVEL SECURITY (RLS) POLICY MODEL                                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚  USER ROLES & PERMISSIONS                                                       â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                     â”‚
â”‚                                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚    ADMIN     â”‚     â”‚   MANAGER    â”‚     â”‚     USER     â”‚                  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                  â”‚
â”‚  â”‚ â€¢ Full CRUD  â”‚     â”‚ â€¢ Read ALL   â”‚     â”‚ â€¢ Read ALL   â”‚                  â”‚
â”‚  â”‚ â€¢ Config     â”‚     â”‚ â€¢ Update     â”‚     â”‚ â€¢ Update OWN â”‚                  â”‚
â”‚  â”‚   systems    â”‚     â”‚   team's     â”‚     â”‚ â€¢ Create     â”‚                  â”‚
â”‚  â”‚ â€¢ Delete ALL â”‚     â”‚ â€¢ Reports    â”‚     â”‚ â€¢ No delete  â”‚                  â”‚
â”‚  â”‚ â€¢ Audit logs â”‚     â”‚ â€¢ No delete  â”‚     â”‚              â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                                                                                 â”‚
â”‚                                                                                 â”‚
â”‚  TABLE-SPECIFIC POLICIES                                                        â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                       â”‚
â”‚                                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚  â”‚  TABLE: opportunities                                   â”‚                   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                   â”‚
â”‚  â”‚                                                         â”‚                   â”‚
â”‚  â”‚  SELECT (READ):                                         â”‚                   â”‚
â”‚  â”‚  âœ… ALL authenticated users can read ALL opportunities â”‚                   â”‚
â”‚  â”‚     (small team, no data isolation needed)              â”‚                   â”‚
â”‚  â”‚                                                         â”‚                   â”‚
â”‚  â”‚  INSERT (CREATE):                                       â”‚                   â”‚
â”‚  â”‚  âœ… Any user can create                                 â”‚                   â”‚
â”‚  â”‚  âœ… Auto-set created_by = auth.uid()                    â”‚                   â”‚
â”‚  â”‚                                                         â”‚                   â”‚
â”‚  â”‚  UPDATE (MODIFY):                                       â”‚                   â”‚
â”‚  â”‚  âœ… Creator (created_by = auth.uid())                   â”‚                   â”‚
â”‚  â”‚  âœ… Assignee (assigned_to = auth.uid())                 â”‚                   â”‚
â”‚  â”‚  âœ… Admin (role = 'admin')                              â”‚                   â”‚
â”‚  â”‚                                                         â”‚                   â”‚
â”‚  â”‚  DELETE (REMOVE):                                       â”‚                   â”‚
â”‚  â”‚  âœ… Admin ONLY                                          â”‚                   â”‚
â”‚  â”‚                                                         â”‚                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚                                                                                 â”‚
â”‚                                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚  â”‚  TABLE: notes (IMMUTABLE)                               â”‚                   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                   â”‚
â”‚  â”‚                                                         â”‚                   â”‚
â”‚  â”‚  SELECT: âœ… All users                                   â”‚                   â”‚
â”‚  â”‚  INSERT: âœ… All users (created_by = auth.uid())         â”‚                   â”‚
â”‚  â”‚  UPDATE: âŒ BLOCKED (notes are append-only)             â”‚                   â”‚
â”‚  â”‚  DELETE: âœ… Admin ONLY (exceptional cases)              â”‚                   â”‚
â”‚  â”‚                                                         â”‚                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚                                                                                 â”‚
â”‚                                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚  â”‚  TABLE: funnels & funnel_stages (ADMIN-ONLY)           â”‚                   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                   â”‚
â”‚  â”‚                                                         â”‚                   â”‚
â”‚  â”‚  SELECT: âœ… All users (read-only)                       â”‚                   â”‚
â”‚  â”‚  INSERT: âœ… Admin ONLY                                  â”‚                   â”‚
â”‚  â”‚  UPDATE: âœ… Admin ONLY                                  â”‚                   â”‚
â”‚  â”‚  DELETE: âœ… Admin ONLY                                  â”‚                   â”‚
â”‚  â”‚                                                         â”‚                   â”‚
â”‚  â”‚  RATIONALE: Pipeline config is structural,             â”‚                   â”‚
â”‚  â”‚             only admins should modify                   â”‚                   â”‚
â”‚  â”‚                                                         â”‚                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚                                                                                 â”‚
â”‚                                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚  â”‚  TABLE: activity_log (SYSTEM-MANAGED)                  â”‚                   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                   â”‚
â”‚  â”‚                                                         â”‚                   â”‚
â”‚  â”‚  SELECT: âœ… All users (read-only)                       â”‚                   â”‚
â”‚  â”‚  INSERT: âŒ BLOCKED (only DB triggers can insert)       â”‚                   â”‚
â”‚  â”‚  UPDATE: âŒ BLOCKED (immutable audit trail)             â”‚                   â”‚
â”‚  â”‚  DELETE: âœ… Admin ONLY (GDPR compliance)                â”‚                   â”‚
â”‚  â”‚                                                         â”‚                   â”‚
â”‚  â”‚  HOW IT WORKS:                                          â”‚                   â”‚
â”‚  â”‚  1. User updates opportunity                            â”‚                   â”‚
â”‚  â”‚  2. PostgreSQL trigger fires                            â”‚                   â”‚
â”‚  â”‚  3. Trigger inserts into activity_log (SECURITY DEFINER)â”‚                   â”‚
â”‚  â”‚  4. User cannot directly manipulate logs                â”‚                   â”‚
â”‚  â”‚                                                         â”‚                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š DIAGRAM 4: Component Hierarchy (Protocol Notecraftâ„¢)

```ascii
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STAGETEK CRM - COMPONENT HIERARCHY (Atomic Design)                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚ PAGES (10 components, 80-150 lines each, NOT governed by Protocol)             â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚  Login.tsx â”‚  â”‚Dashboard   â”‚  â”‚Oportunidadesâ”‚  â”‚  Funil.tsx â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚Clientes.tsxâ”‚  â”‚ConfigFunis â”‚  â”‚DetalheOportâ”‚  â”‚NovaCotacao â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                                                                 â”‚
â”‚         â”‚                                                                       â”‚
â”‚         â”‚ (compose)                                                             â”‚
â”‚         â–¼                                                                       â”‚
â”‚                                                                                 â”‚
â”‚ TEMPLATES (â‰¤30 lines) - Full page layouts                                      â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚  â”‚  MainLayout    â”‚                  â”‚ QuotationPDF   â”‚                       â”‚
â”‚  â”‚  (28 lines)    â”‚                  â”‚  (28 lines)    â”‚                       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚         â”‚                                      â”‚                               â”‚
â”‚         â”‚ (compose)                            â”‚ (uses)                        â”‚
â”‚         â–¼                                      â–¼                               â”‚
â”‚                                                                                 â”‚
â”‚ ORGANISMS (â‰¤50 lines) - Complex UI sections                                    â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚ TopBar   â”‚  â”‚ClientTableâ”‚ â”‚OppsTable â”‚  â”‚ProductCatâ”‚  â”‚QuotationCâ”‚       â”‚
â”‚  â”‚ (44 ln)  â”‚  â”‚ (48 ln)  â”‚  â”‚ (47 ln)  â”‚  â”‚ (45 ln)  â”‚  â”‚art(50 ln)â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚ClienteM. â”‚  â”‚OportunidM.â”‚  â”‚TaskList  â”‚  â”‚TaskForm  â”‚  â”‚Timeline  â”‚       â”‚
â”‚  â”‚ (47 ln)  â”‚  â”‚ (50 ln)  â”‚  â”‚ (48 ln)  â”‚  â”‚ (49 ln)  â”‚  â”‚ (46 ln)  â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚         â”‚                                      â”‚                               â”‚
â”‚         â”‚ (compose)                            â”‚ (uses)                        â”‚
â”‚         â–¼                                      â–¼                               â”‚
â”‚                                                                                 â”‚
â”‚ MOLECULES (â‰¤35 lines) - Composite components                                   â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚ Badge   â”‚  â”‚ Button  â”‚  â”‚Checkbox â”‚  â”‚ Select  â”‚  â”‚FormFieldâ”‚            â”‚
â”‚  â”‚ (18 ln) â”‚  â”‚ (22 ln) â”‚  â”‚ (19 ln) â”‚  â”‚ (28 ln) â”‚  â”‚ (17 ln) â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚ClientC. â”‚  â”‚OpportunC.â”‚  â”‚ProductC.â”‚  â”‚QuotationIâ”‚ â”‚QuotationTâ”‚            â”‚
â”‚  â”‚ (27 ln) â”‚  â”‚ (32 ln) â”‚  â”‚ (27 ln) â”‚  â”‚ (22 ln) â”‚  â”‚ (35 ln) â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚TaskCard â”‚  â”‚ContactC.â”‚  â”‚TimelineIâ”‚  â”‚Breadcrumbâ”‚ â”‚KanbanColâ”‚            â”‚
â”‚  â”‚ (24 ln) â”‚  â”‚ (29 ln) â”‚  â”‚ (28 ln) â”‚  â”‚ (21 ln) â”‚  â”‚ (35 ln) â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚         â”‚                                      â”‚                               â”‚
â”‚         â”‚ (compose)                            â”‚ (uses)                        â”‚
â”‚         â–¼                                      â–¼                               â”‚
â”‚                                                                                 â”‚
â”‚ ATOMS (â‰¤20 lines) - Basic building blocks                                      â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚ Spinner â”‚  â”‚ Avatar  â”‚  â”‚  Stars  â”‚  â”‚  Input  â”‚  â”‚  Label  â”‚            â”‚
â”‚  â”‚ (12 ln) â”‚  â”‚ (16 ln) â”‚  â”‚ (18 ln) â”‚  â”‚ (15 ln) â”‚  â”‚ (14 ln) â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                     â”‚
â”‚  â”‚Notificatâ”‚  â”‚  (more) â”‚                                                     â”‚
â”‚  â”‚Badge    â”‚  â”‚         â”‚                                                     â”‚
â”‚  â”‚ (13 ln) â”‚  â”‚         â”‚                                                     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                     â”‚
â”‚                                                                                 â”‚
â”‚                                                                                 â”‚
â”‚ EXTERNAL (shadcn/ui) - NOT governed by Protocol (allowed)                      â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚ui/badge â”‚  â”‚ui/buttonâ”‚  â”‚ui/check â”‚  â”‚ui/input â”‚  â”‚ui/label â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                                   â”‚
â”‚  â”‚ui/selectâ”‚                                                                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                                   â”‚
â”‚                                                                                 â”‚
â”‚                                                                                 â”‚
â”‚ COMPLIANCE METRICS:                                                             â”‚
â”‚ âœ… Atoms: 7/7 compliant (100%)                                                 â”‚
â”‚ âœ… Molecules: 22/22 compliant (100%)                                           â”‚
â”‚ âœ… Organisms: 15/15 compliant (100%)                                           â”‚
â”‚ âœ… Templates: 2/2 compliant (100%)                                             â”‚
â”‚ âœ… TOTAL: 46/46 custom components = 100% Protocol Notecraftâ„¢ compliance       â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š DIAGRAM 5: Critical Path Refactoring Flow

```ascii
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CRITICAL PATH: MVP â†’ PRODUCTION â†’ GROWTH                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚ PHASE 0: SECURITY BLOCKERS (Week 1) - MANDATORY BEFORE PRODUCTION              â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€        â”‚
â”‚                                                                                 â”‚
â”‚  Day 1 â”‚  RLS Policies (activity_log, storage)                                 â”‚
â”‚        â”‚  â””â”€â–º Fix: Block user INSERT/UPDATE on activity_log                    â”‚
â”‚        â”‚  â””â”€â–º Add: Storage policies for product images                         â”‚
â”‚        â”‚       Time: 4 hours                                                    â”‚
â”‚        â”‚                                                                         â”‚
â”‚  Day 2 â”‚  Missing Indexes (opportunities, tasks)                               â”‚
â”‚        â”‚  â””â”€â–º Add: idx_opportunities_expected_close_date                       â”‚
â”‚        â”‚  â””â”€â–º Add: idx_opportunities_status_stage_id (composite)               â”‚
â”‚        â”‚  â””â”€â–º Add: idx_tasks_due_date_completed (composite)                    â”‚
â”‚        â”‚       Time: 2 hours                                                    â”‚
â”‚        â”‚                                                                         â”‚
â”‚  Day 3 â”‚  Schema: Create contacts table                                        â”‚
â”‚  Day 4 â”‚  Schema: Create loss_reasons + sources tables                         â”‚
â”‚        â”‚  â””â”€â–º Migrate existing data (clients.email â†’ contacts)                 â”‚
â”‚        â”‚  â””â”€â–º Seed loss_reasons (6 default reasons)                            â”‚
â”‚        â”‚  â””â”€â–º Seed sources (8 default sources)                                 â”‚
â”‚        â”‚       Time: 2 days                                                     â”‚
â”‚        â”‚                                                                         â”‚
â”‚  Day 5 â”‚  Audit & Testing                                                      â”‚
â”‚        â”‚  â””â”€â–º Test: RLS policies (authenticated + anon)                        â”‚
â”‚        â”‚  â””â”€â–º Test: Triggers fire correctly                                    â”‚
â”‚        â”‚  â””â”€â–º Test: Data migration integrity                                   â”‚
â”‚        â”‚       Time: 1 day                                                      â”‚
â”‚        â”‚                                                                         â”‚
â”‚        â–¼                                                                         â”‚
â”‚  âœ… Checkpoint: Production-ready security âœ…                                    â”‚
â”‚                                                                                 â”‚
â”‚                                                                                 â”‚
â”‚ PHASE 1: STATE MANAGEMENT (Week 2) - FOUNDATION FOR REAL-TIME                  â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€        â”‚
â”‚                                                                                 â”‚
â”‚  Day 6 â”‚  Setup Zustand Stores                                                 â”‚
â”‚        â”‚  â””â”€â–º Create: stores/opportunityStore.ts                               â”‚
â”‚        â”‚  â””â”€â–º Create: stores/clientStore.ts                                    â”‚
â”‚        â”‚  â””â”€â–º Create: stores/taskStore.ts                                      â”‚
â”‚        â”‚       Time: 1 day                                                      â”‚
â”‚        â”‚                                                                         â”‚
â”‚  Day 7 â”‚  Refactor Pages to use Stores (Part 1)                                â”‚
â”‚  Day 8 â”‚  Refactor Pages to use Stores (Part 2)                                â”‚
â”‚        â”‚  â””â”€â–º Refactor: Funil.tsx                                              â”‚
â”‚        â”‚  â””â”€â–º Refactor: Oportunidades.tsx                                      â”‚
â”‚        â”‚  â””â”€â–º Refactor: DetalheOportunidade.tsx                                â”‚
â”‚        â”‚       Time: 2 days                                                     â”‚
â”‚        â”‚                                                                         â”‚
â”‚  Day 9 â”‚  Implement Supabase Realtime Subscriptions                            â”‚
â”‚        â”‚  â””â”€â–º Subscribe: opportunities table                                   â”‚
â”‚        â”‚  â””â”€â–º Subscribe: tasks table                                           â”‚
â”‚        â”‚  â””â”€â–º Handle: Real-time updates (INSERT/UPDATE/DELETE)                 â”‚
â”‚        â”‚       Time: 1 day                                                      â”‚
â”‚        â”‚                                                                         â”‚
â”‚  Day 10â”‚  Optimistic Updates + Rollback                                        â”‚
â”‚        â”‚  â””â”€â–º Implement: Instant UI updates (pre-DB response)                  â”‚
â”‚        â”‚  â””â”€â–º Implement: Rollback on error (toast notification)                â”‚
â”‚        â”‚       Time: 1 day                                                      â”‚
â”‚        â”‚                                                                         â”‚
â”‚        â–¼                                                                         â”‚
â”‚  âœ… Checkpoint: Real-time sync working âœ…                                       â”‚
â”‚                                                                                 â”‚
â”‚                                                                                 â”‚
â”‚ PHASE 2: SCHEMA COMPLETION (Week 3) - ENABLE ADVANCED FEATURES                 â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€        â”‚
â”‚                                                                                 â”‚
â”‚  Day 11â”‚  Update opportunities table                                           â”‚
â”‚        â”‚  â””â”€â–º Add: contact_ids JSONB (array of UUIDs)                          â”‚
â”‚        â”‚  â””â”€â–º Add: loss_reason_id FK                                           â”‚
â”‚        â”‚  â””â”€â–º Add: source_id FK                                                 â”‚
â”‚        â”‚       Time: 1 day                                                      â”‚
â”‚        â”‚                                                                         â”‚
â”‚  Day 12â”‚  Create teams table                                                   â”‚
â”‚        â”‚  â””â”€â–º Schema: teams (id, name, manager_id)                             â”‚
â”‚        â”‚  â””â”€â–º Update: users.team_id FK                                         â”‚
â”‚        â”‚  â””â”€â–º RLS: Team-based visibility policies                              â”‚
â”‚        â”‚       Time: 1 day                                                      â”‚
â”‚        â”‚                                                                         â”‚
â”‚  Day 13â”‚  Create email_templates table                                         â”‚
â”‚        â”‚  â””â”€â–º Schema: email_templates (name, subject, body, variables)         â”‚
â”‚        â”‚  â””â”€â–º Seed: 3 default templates                                        â”‚
â”‚        â”‚  â””â”€â–º Hook: useEmailTemplates (CRUD)                                   â”‚
â”‚        â”‚       Time: 1 day                                                      â”‚
â”‚        â”‚                                                                         â”‚
â”‚  Day 14â”‚  Migration & Testing                                                  â”‚
â”‚  Day 15â”‚  â””â”€â–º Migrate: Existing opportunities (link to contacts)               â”‚
â”‚        â”‚  â””â”€â–º Test: M2M relationships (opportunity â†” contacts)                 â”‚
â”‚        â”‚  â””â”€â–º Test: Loss reasons dropdown (structured data)                    â”‚
â”‚        â”‚       Time: 2 days                                                     â”‚
â”‚        â”‚                                                                         â”‚
â”‚        â–¼                                                                         â”‚
â”‚  âœ… Checkpoint: Schema 95% RD Station parity âœ…                                 â”‚
â”‚                                                                                 â”‚
â”‚                                                                                 â”‚
â”‚ PHASE 3: UI COMPONENTS (Week 4) - VISUAL PARITY WITH RD STATION                â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€        â”‚
â”‚                                                                                 â”‚
â”‚  Day 16â”‚  FunnelStageIndicator (bolinhas conectadas)                           â”‚
â”‚        â”‚  â””â”€â–º Component: molecule, 32 lines                                    â”‚
â”‚        â”‚  â””â”€â–º Integration: Opportunity details page                            â”‚
â”‚        â”‚       Time: 1 day                                                      â”‚
â”‚        â”‚                                                                         â”‚
â”‚  Day 17â”‚  QualificationStars (5-star rating)                                   â”‚
â”‚        â”‚  â””â”€â–º Component: atom, 18 lines                                        â”‚
â”‚        â”‚  â””â”€â–º Integration: OpportunityCard, Opportunity details                â”‚
â”‚        â”‚       Time: 4 hours                                                    â”‚
â”‚        â”‚                                                                         â”‚
â”‚        â”‚  FilterBar (advanced filters + badge)                                 â”‚
â”‚        â”‚  â””â”€â–º Component: molecule, 35 lines                                    â”‚
â”‚        â”‚  â””â”€â–º Integration: Funil page                                          â”‚
â”‚        â”‚       Time: 4 hours                                                    â”‚
â”‚        â”‚                                                                         â”‚
â”‚  Day 18â”‚  OpportunityTooltip (hover preview)                                   â”‚
â”‚        â”‚  â””â”€â–º Component: molecule, 28 lines                                    â”‚
â”‚        â”‚  â””â”€â–º Integration: Kanban cards                                        â”‚
â”‚        â”‚       Time: 1 day                                                      â”‚
â”‚        â”‚                                                                         â”‚
â”‚  Day 19â”‚  Mobile UX Improvements (Part 1)                                      â”‚
â”‚  Day 20â”‚  Mobile UX Improvements (Part 2)                                      â”‚
â”‚        â”‚  â””â”€â–º Swipe gestures (Kanban stage navigation)                         â”‚
â”‚        â”‚  â””â”€â–º Collapsible sidebars (Opportunity details)                       â”‚
â”‚        â”‚  â””â”€â–º Bottom sheet filters (mobile-first)                              â”‚
â”‚        â”‚       Time: 2 days                                                     â”‚
â”‚        â”‚                                                                         â”‚
â”‚        â–¼                                                                         â”‚
â”‚  âœ… Checkpoint: UI/UX parity with RD Station âœ…                                 â”‚
â”‚                                                                                 â”‚
â”‚                                                                                 â”‚
â”‚ PHASE 4+: ADVANCED FEATURES (Weeks 5-8) - P1 RD STATION FEATURES               â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€        â”‚
â”‚                                                                                 â”‚
â”‚  Week 5 â”‚  Detalhes Oportunidade (6 tabs complete)                             â”‚
â”‚  Week 6 â”‚  RelatÃ³rios de ConversÃ£o + CRM Live                                  â”‚
â”‚  Week 7 â”‚  Email Templates + WYSIWYG Composer                                  â”‚
â”‚  Week 8 â”‚  WhatsApp Integration (Rube MCP)                                     â”‚
â”‚         â”‚                                                                        â”‚
â”‚         â–¼                                                                        â”‚
â”‚  âœ… Checkpoint: PRODUCTION LAUNCH âœ…                                            â”‚
â”‚                                                                                 â”‚
â”‚                                                                                 â”‚
â”‚ TIMELINE SUMMARY:                                                               â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                              â”‚
â”‚ Week 1:  Security Blockers (MANDATORY)                                         â”‚
â”‚ Week 2:  State Management (Foundation)                                         â”‚
â”‚ Week 3:  Schema Completion (RD Station parity)                                 â”‚
â”‚ Week 4:  UI Components (Visual parity)                                         â”‚
â”‚ Week 5-8: Advanced Features (P1 features)                                      â”‚
â”‚                                                                                 â”‚
â”‚ TOTAL: 8 weeks to full RD Station P1 feature parity                            â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š DIAGRAM 6: Performance Optimization Strategy

```ascii
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PERFORMANCE OPTIMIZATION LAYERS                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚ LAYER 1: DATABASE (PostgreSQL)                                                 â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                    â”‚
â”‚                                                                                 â”‚
â”‚  âœ… Current Indexes (good coverage):                                           â”‚
â”‚     â€¢ idx_clients_cnpj                                                          â”‚
â”‚     â€¢ idx_opportunities_stage_id                                                â”‚
â”‚     â€¢ idx_opportunities_client_id                                               â”‚
â”‚     â€¢ idx_tasks_opportunity_id                                                  â”‚
â”‚     â€¢ idx_activity_log_created_at (DESC)                                        â”‚
â”‚                                                                                 â”‚
â”‚  âš ï¸ Missing Indexes (add in Week 1):                                           â”‚
â”‚     â€¢ idx_opportunities_expected_close_date  â† Reports query this often        â”‚
â”‚     â€¢ idx_opportunities_status_stage_id       â† Kanban queries (composite)     â”‚
â”‚     â€¢ idx_tasks_due_date_completed            â† Task filtering (composite)     â”‚
â”‚                                                                                 â”‚
â”‚  ğŸ”¥ Query Performance Projection:                                               â”‚
â”‚     â€¢ Kanban board: 80ms â†’ 10ms (8x faster)                                    â”‚
â”‚     â€¢ Overdue tasks: 50ms â†’ 5ms (10x faster)                                   â”‚
â”‚     â€¢ Reports: 100ms â†’ 8ms (12.5x faster)                                      â”‚
â”‚                                                                                 â”‚
â”‚         â–¼                                                                        â”‚
â”‚                                                                                 â”‚
â”‚ LAYER 2: BACKEND (Supabase Client)                                             â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                    â”‚
â”‚                                                                                 â”‚
â”‚  âœ… Current:                                                                    â”‚
â”‚     â€¢ Direct fetch() calls (no caching)                                         â”‚
â”‚     â€¢ Re-fetch on every route change                                            â”‚
â”‚     â€¢ Average query time: 150ms                                                 â”‚
â”‚                                                                                 â”‚
â”‚  ğŸ”¥ After Zustand (Week 2):                                                     â”‚
â”‚     â€¢ In-memory cache (instant reads)                                           â”‚
â”‚     â€¢ Fetch once, reuse across routes                                           â”‚
â”‚     â€¢ Average query time: 5ms (30x faster)                                      â”‚
â”‚                                                                                 â”‚
â”‚         â–¼                                                                        â”‚
â”‚                                                                                 â”‚
â”‚ LAYER 3: REALTIME SYNC (WebSocket)                                             â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                    â”‚
â”‚                                                                                 â”‚
â”‚  âœ… After Implementation (Week 2):                                              â”‚
â”‚     â€¢ Single WebSocket per user                                                 â”‚
â”‚     â€¢ Subscribe to 3 channels (opportunities, tasks, clients)                   â”‚
â”‚     â€¢ Real-time updates (User A sees User B's changes instantly)                â”‚
â”‚     â€¢ Bandwidth: ~5KB/min (negligible)                                          â”‚
â”‚                                                                                 â”‚
â”‚         â–¼                                                                        â”‚
â”‚                                                                                 â”‚
â”‚ LAYER 4: UI (React)                                                            â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                    â”‚
â”‚                                                                                 â”‚
â”‚  âœ… Current:                                                                    â”‚
â”‚     â€¢ Re-render on every state change                                           â”‚
â”‚     â€¢ No memoization                                                            â”‚
â”‚     â€¢ Drag-drop waits for DB (sluggish)                                         â”‚
â”‚                                                                                 â”‚
â”‚  ğŸ”¥ After Optimization (Week 2):                                                â”‚
â”‚     â€¢ Optimistic updates (instant UI)                                           â”‚
â”‚     â€¢ React.memo() on expensive components                                      â”‚
â”‚     â€¢ useMemo() for computed values                                             â”‚
â”‚     â€¢ Drag-drop feels instant (0ms perceived latency)                           â”‚
â”‚                                                                                 â”‚
â”‚         â–¼                                                                        â”‚
â”‚                                                                                 â”‚
â”‚ LAYER 5: ASSETS (Static Resources)                                             â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                    â”‚
â”‚                                                                                 â”‚
â”‚  âœ… Current:                                                                    â”‚
â”‚     â€¢ Vite code-splitting (automatic)                                           â”‚
â”‚     â€¢ Tailwind CSS purge (production only)                                      â”‚
â”‚     â€¢ Bundle size: ~350KB gzipped                                               â”‚
â”‚                                                                                 â”‚
â”‚  ğŸ¯ Target:                                                                     â”‚
â”‚     â€¢ Bundle size: <300KB gzipped                                               â”‚
â”‚     â€¢ Lighthouse Score: >85 (currently ~78)                                     â”‚
â”‚     â€¢ FCP (First Contentful Paint): <1.5s                                       â”‚
â”‚     â€¢ LCP (Largest Contentful Paint): <2.5s                                     â”‚
â”‚                                                                                 â”‚
â”‚                                                                                 â”‚
â”‚ PERFORMANCE METRICS (Before vs After)                                          â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                           â”‚
â”‚                                                                                 â”‚
â”‚  â”‚ METRIC                  â”‚ CURRENT â”‚ AFTER OPT â”‚ IMPROVEMENT â”‚               â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤               â”‚
â”‚  â”‚ Kanban Load Time        â”‚  1.2s   â”‚   0.3s    â”‚   4x faster â”‚               â”‚
â”‚  â”‚ Drag-drop Response      â”‚  200ms  â”‚   0ms     â”‚  Instant    â”‚               â”‚
â”‚  â”‚ Route Change            â”‚  800ms  â”‚   50ms    â”‚  16x faster â”‚               â”‚
â”‚  â”‚ Real-time Sync Delay    â”‚  N/A    â”‚   <100ms  â”‚  Enabled    â”‚               â”‚
â”‚  â”‚ Bundle Size (gzipped)   â”‚  350KB  â”‚   280KB   â”‚  20% smallerâ”‚               â”‚
â”‚  â”‚ Lighthouse Score        â”‚   78    â”‚    88     â”‚  +10 points â”‚               â”‚
â”‚                                                                                 â”‚
â”‚                                                                                 â”‚
â”‚ SUPABASE FREE TIER MONITORING                                                   â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                           â”‚
â”‚                                                                                 â”‚
â”‚  Resource Usage (Current Projection):                                          â”‚
â”‚  â€¢ Database Size: ~50MB/month (10% of 500MB limit)     âœ… SAFE                â”‚
â”‚  â€¢ Storage: ~1GB/year (50% of 2GB limit)               âš ï¸ MONITOR              â”‚
â”‚  â€¢ API Requests: ~100MB/month (20% of 500MB limit)     âœ… SAFE                â”‚
â”‚  â€¢ Realtime: ~500K msg/month (25% of 2M limit)         âœ… SAFE                â”‚
â”‚  â€¢ Concurrent Users: 5-10 (5% of 100-200 limit)        âœ… SAFE                â”‚
â”‚                                                                                 â”‚
â”‚  Mitigation for Storage Risk (Year 2+):                                        â”‚
â”‚  1. Cold-storage: Move PDFs >90 days to Cloudflare R2 (10x cheaper)           â”‚
â”‚  2. Compression: Reduce PDF size from 500KB â†’ 150KB (3x reduction)             â”‚
â”‚  3. Cleanup: Delete draft quotations after 30 days                             â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

**END OF DIAGRAMS**

These diagrams complement the main **ARCHITECTURE-VIABILITY-ANALYSIS.md** document and provide visual references for:
- Current vs proposed architecture
- Database schema evolution
- RLS policy model
- Component hierarchy
- Critical path refactoring
- Performance optimization layers

---

**Built with ASCII art precision**
**STAGETEK Engineering Team**
**Date**: 24 October 2025
